<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAK - Never Miss an ADAS Calibration Again</title>
    <meta name="description" content="TRAK is the operating system for ADAS calibration businesses and collision centers. Scheduling, reporting, workflow, billing, analytics, and customer access in one platform.">
    <link rel="canonical" href="https://adastrak.com">
    <link rel="icon" type="image/jpeg" href="logo-icon.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --red: #DC2626;
            --red-light: #EF4444;
            --dark: #1a1a1a;
            --gray: #6b7280;
            --white: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--dark);
            background: var(--white);
            background-image: radial-gradient(ellipse at 50% 0%, #fef2f2 0%, var(--white) 70%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 24px 24px;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            text-align: center;
            max-width: 820px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .logo {
            height: 50px;
            margin-bottom: 28px;
            animation: fadeUp 0.6s ease-out both;
        }

        h1 {
            font-size: clamp(32px, 4.5vw, 46px);
            font-weight: 900;
            line-height: 1.08;
            letter-spacing: -1.5px;
            margin-bottom: 16px;
            animation: fadeUp 0.6s ease-out 0.1s both;
        }

        h1 span { color: var(--red); }

        p {
            font-size: 15px;
            color: var(--gray);
            line-height: 1.6;
            max-width: 540px;
            margin: 0 auto 28px;
            animation: fadeUp 0.6s ease-out 0.2s both;
        }

        .ctas {
            display: flex;
            justify-content: center;
            gap: 14px;
            flex-wrap: wrap;
            margin-bottom: 32px;
            animation: fadeUp 0.6s ease-out 0.3s both;
        }

        .btn {
            display: inline-block;
            padding: 12px 28px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 15px;
            text-decoration: none;
            transition: all 0.25s ease;
        }

        .btn-primary {
            background: var(--red);
            color: var(--white);
            box-shadow: 0 4px 14px rgba(220, 38, 38, 0.3);
        }

        .btn-primary:hover {
            background: var(--red-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        .btn-outline {
            background: var(--white);
            color: var(--dark);
            border: 1.5px solid #d1d5db;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .btn-outline:hover {
            border-color: var(--red);
            color: var(--red);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        .btn-outline:active {
            transform: translateY(0);
        }

        .features {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            max-width: 800px;
            margin: 0 auto 32px;
            text-align: left;
        }

        .feature-card {
            padding: 18px;
            border-radius: 12px;
            border: 1px solid #f3f4f6;
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.25s ease;
        }

        .feature-card:hover {
            border-color: #e5e7eb;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
        }

        .feature-icon {
            width: 32px;
            height: 32px;
            background: #fef2f2;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .feature-icon svg {
            width: 16px;
            height: 16px;
            stroke: var(--red);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .feature-card h3 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--dark);
        }

        .feature-card p {
            font-size: 12.5px;
            color: var(--gray);
            line-height: 1.45;
            margin: 0;
            max-width: none;
            animation: none;
        }

        .bottom-cta {
            text-align: center;
            margin-bottom: 56px;
        }

        .bottom-cta h2 {
            font-size: clamp(22px, 3vw, 28px);
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 12px;
        }

        .bottom-cta p {
            font-size: 15px;
            color: var(--gray);
            margin: 0 auto 24px;
            animation: none;
        }

        @media (max-width: 640px) {
            .features {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        .divider {
            width: 48px;
            height: 2px;
            background: #e5e7eb;
            margin: 0 auto 16px;
            animation: fadeUp 0.6s ease-out 0.4s both;
        }

        .footer-text {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 0;
            animation: fadeUp 0.6s ease-out 0.45s both;
        }

        .footer-text a {
            color: var(--red);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .footer-text a:hover { text-decoration: underline; }

        .footer-contact {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 4px;
            animation: fadeUp 0.6s ease-out 0.45s both;
        }

        .footer-contact a {
            color: #9ca3af;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-contact a:hover { color: var(--gray); text-decoration: underline; }

        .footer-links {
            font-size: 12px;
            color: #d1d5db;
            margin-bottom: 0;
            animation: fadeUp 0.6s ease-out 0.5s both;
        }

        .footer-links a {
            color: #9ca3af;
            text-decoration: none;
            font-weight: 400;
            transition: color 0.2s;
        }

        .footer-links a:hover { color: var(--gray); text-decoration: underline; }

        /* Decorative ADAS equipment illustrations */
        .deco {
            position: fixed;
            pointer-events: none;
            z-index: 0;
            opacity: 0;
            animation: decoFade 1s ease-out forwards;
        }

        .deco svg {
            stroke: #e5d0d0;
            fill: none;
            stroke-width: 1.2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        @keyframes decoFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .deco-tablet {
            top: 6%;
            left: 3%;
            width: 120px;
            transform: rotate(-12deg);
            animation-delay: 0.6s;
        }

        .deco-target {
            top: 4%;
            right: 3%;
            width: 110px;
            transform: rotate(8deg);
            animation-delay: 0.8s;
        }

        .deco-radar {
            bottom: 8%;
            left: 4%;
            width: 100px;
            transform: rotate(6deg);
            animation-delay: 1s;
        }

        .deco-stand {
            bottom: 6%;
            right: 3%;
            width: 90px;
            transform: rotate(-5deg);
            animation-delay: 1.2s;
        }

        @media (max-width: 1100px) {
            .deco { display: none; }
        }

        /* Password Modal */
        .password-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .password-overlay.active { opacity: 1; }
        .password-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .password-overlay.active .password-modal { transform: scale(1); }
        .password-modal h2 {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        .password-modal .modal-subtitle {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 24px;
            max-width: none;
            animation: none;
        }
        .password-modal input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #d1d5db;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 8px;
            text-align: center;
            letter-spacing: 2px;
        }
        .password-modal input:focus { border-color: var(--red); }
        .password-modal input.shake {
            animation: shake 0.4s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .password-error {
            color: var(--red);
            font-size: 13px;
            margin-bottom: 12px;
            display: none;
            max-width: none;
            animation: none;
        }
        .password-modal .modal-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--red);
            color: white;
            margin-bottom: 10px;
        }
        .password-modal .modal-btn:hover { background: var(--red-light); }
        .password-modal .modal-cancel {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            padding: 8px;
        }
        .password-modal .modal-cancel:hover { color: var(--dark); }

        /* Mapper Section */
        .mapper-section {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 900;
            overflow-y: auto;
            display: none;
            animation: fadeUp 0.4s ease-out;
        }
        .mapper-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 32px;
            border-bottom: 1px solid #f3f4f6;
        }
        .mapper-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .mapper-header img { height: 32px; }
        .mapper-header h1 {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin: 0;
            animation: none;
        }
        .mapper-back {
            background: none;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.2s;
        }
        .mapper-back:hover { border-color: var(--red); color: var(--red); }
        .mapper-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 48px 24px;
        }
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 16px;
            padding: 64px 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--red);
            background: #fef2f2;
        }
        .upload-zone-icon {
            width: 56px;
            height: 56px;
            background: #fef2f2;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        .upload-zone-icon svg {
            width: 28px;
            height: 28px;
            stroke: var(--red);
            fill: none;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .upload-zone h3 {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        .upload-zone p {
            font-size: 14px;
            color: var(--gray);
            margin: 0;
            animation: none;
            max-width: none;
        }
        .upload-zone .browse-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 24px;
            background: var(--red);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upload-zone .browse-btn:hover { background: var(--red-light); }

        /* Processing State */
        .processing-state {
            text-align: center;
            padding: 64px 32px;
            display: none;
        }
        .processing-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #f3f4f6;
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .processing-state p {
            font-size: 15px;
            color: var(--gray);
            animation: none;
            max-width: none;
        }

        /* Results */
        .results-section { display: none; }
        .results-header {
            text-align: center;
            margin-bottom: 32px;
        }
        .results-header h2 {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }
        .results-vehicle {
            font-size: 15px;
            color: var(--gray);
            margin-bottom: 4px;
            max-width: none;
            animation: none;
        }
        .results-file {
            font-size: 13px;
            color: #9ca3af;
            margin: 4px auto 16px;
            max-width: none;
            animation: none;
        }
        .results-summary {
            display: inline-block;
            padding: 6px 14px;
            background: #fef2f2;
            color: var(--red);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .results-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 32px;
        }
        .calibration-card {
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            padding: 20px 24px;
            background: white;
            transition: box-shadow 0.2s;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        .calibration-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        .cal-priority {
            width: 4px;
            border-radius: 2px;
            align-self: stretch;
            flex-shrink: 0;
        }
        .cal-priority-high { background: var(--red); }
        .cal-priority-medium { background: #f59e0b; }
        .cal-priority-low { background: #10b981; }
        .cal-info { flex: 1; }
        .cal-info h3 {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--dark);
        }
        .cal-type {
            font-size: 12px;
            font-weight: 600;
            color: var(--red);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .cal-info p {
            font-size: 13px;
            color: var(--gray);
            line-height: 1.5;
            margin: 0;
            animation: none;
            max-width: none;
        }
        .cal-triggers {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f3f4f6;
        }
        .cal-triggers span {
            display: inline-block;
            padding: 3px 10px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            color: var(--gray);
            margin-right: 6px;
            margin-bottom: 4px;
        }
        .no-calibrations {
            text-align: center;
            padding: 48px;
            color: var(--gray);
        }
        .no-calibrations h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        .no-calibrations p { max-width: none; animation: none; }
        .results-actions {
            padding-top: 16px;
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .results-actions button {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            border: 1.5px solid #d1d5db;
            background: white;
            color: var(--dark);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .results-actions button:hover { border-color: var(--red); color: var(--red); }
        .results-actions button svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .btn-download-pdf {
            background: var(--red) !important;
            color: white !important;
            border-color: var(--red) !important;
        }
        .btn-download-pdf:hover {
            background: var(--red-light) !important;
            border-color: var(--red-light) !important;
            color: white !important;
        }
        .history-item-download {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1.5px solid #e5e7eb;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .history-item-download:hover {
            border-color: var(--red);
            background: #fef2f2;
        }
        .history-item-download svg {
            width: 16px;
            height: 16px;
            stroke: var(--gray);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .history-item-download:hover svg { stroke: var(--red); }

        /* History */
        .mapper-header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .mapper-history-btn {
            background: none;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .mapper-history-btn:hover { border-color: var(--red); color: var(--red); }
        .mapper-history-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .history-badge {
            background: var(--red);
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }
        .history-section {
            display: none;
        }
        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        .history-header h2 {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        .history-clear-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .history-clear-btn:hover { color: var(--red); background: #fef2f2; }
        .history-list {
            display: grid;
            gap: 12px;
        }
        .history-item {
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            padding: 16px 20px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .history-item:hover {
            border-color: #e5e7eb;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        .history-item-icon {
            width: 40px;
            height: 40px;
            background: #fef2f2;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .history-item-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--red);
            fill: none;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .history-item-info {
            flex: 1;
            min-width: 0;
        }
        .history-item-info h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item-meta {
            font-size: 12px;
            color: #9ca3af;
        }
        .history-item-stats {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .history-stat {
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        .history-stat-high { background: #fef2f2; color: var(--red); }
        .history-stat-medium { background: #fffbeb; color: #d97706; }
        .history-stat-count { background: #f3f4f6; color: var(--dark); }
        .history-empty {
            text-align: center;
            padding: 64px 32px;
            color: var(--gray);
        }
        .history-empty h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        .history-empty p {
            font-size: 14px;
            max-width: none;
            animation: none;
            margin: 0;
        }

        @media (max-width: 640px) {
            .mapper-header { padding: 16px 20px; }
            .mapper-content { padding: 32px 16px; }
            .upload-zone { padding: 40px 20px; }
            .history-item { flex-wrap: wrap; }
            .history-item-stats { width: 100%; margin-top: 4px; }
        }

        /* Site Navigation */
        .site-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            height: 56px;
            animation: fadeUp 0.4s ease-out both;
        }
        .nav-logo { height: 28px; }
        .nav-logo-link { display: flex; align-items: center; }
        .nav-tabs { display: flex; gap: 4px; }
        .nav-tab {
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            font-family: inherit;
        }
        .nav-tab:hover { color: var(--dark); background: #f9fafb; }
        .nav-tab.active { color: var(--red); background: #fef2f2; font-weight: 600; }

        @media (max-width: 640px) {
            .site-nav { padding: 0 16px; height: 50px; }
            .nav-logo { height: 24px; }
            .nav-tab { padding: 6px 14px; font-size: 13px; }
        }

        /* Technician Hub */
        .techhub-section {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 900;
            overflow-y: auto;
            display: none;
            animation: fadeUp 0.4s ease-out;
        }
        .techhub-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 32px;
            border-bottom: 1px solid #f3f4f6;
        }
        .techhub-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .techhub-header img { height: 32px; }
        .techhub-header h1 {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin: 0;
            animation: none;
        }
        .techhub-back {
            background: none;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.2s;
        }
        .techhub-back:hover { border-color: var(--red); color: var(--red); }
        .techhub-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 48px 24px;
        }
        /* Login Modal */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .login-overlay.active { opacity: 1; }
        .login-overlay.fullscreen {
            background: white;
            backdrop-filter: none;
        }
        .login-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .login-overlay.active .login-modal { transform: scale(1); }
        .login-modal h2 {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        .login-modal .modal-subtitle {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 24px;
            max-width: none;
            animation: none;
        }
        .login-modal input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #d1d5db;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 10px;
        }
        .login-modal input:focus { border-color: var(--red); }
        .login-modal input.shake { animation: shake 0.4s ease; }
        .login-error {
            color: var(--red);
            font-size: 13px;
            margin-bottom: 12px;
            display: none;
            max-width: none;
            animation: none;
        }
        .login-modal .modal-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--red);
            color: white;
            margin-bottom: 10px;
        }
        .login-modal .modal-btn:hover { background: var(--red-light); }
        .login-modal .modal-cancel {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            padding: 8px;
        }
        .login-modal .modal-cancel:hover { color: var(--dark); }

        /* Dashboard Tabs */
        .techhub-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 28px;
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 12px;
        }
        .techhub-tab {
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            font-family: inherit;
        }
        .techhub-tab:hover { color: var(--dark); background: #f9fafb; }
        .techhub-tab.active { color: var(--red); background: #fef2f2; font-weight: 600; }
        .techhub-panel { display: none; }
        .techhub-panel.active { display: block; }

        /* User Info in Header */
        .techhub-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .techhub-user-email {
            font-size: 13px;
            color: var(--gray);
        }
        .techhub-signout {
            background: none;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.2s;
        }
        .techhub-signout:hover { border-color: var(--red); color: var(--red); }

        /* Documents Section */
        .th-upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 16px;
            padding: 40px 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            margin-bottom: 24px;
        }
        .th-upload-zone:hover, .th-upload-zone.dragover {
            border-color: var(--red);
            background: #fef2f2;
        }
        .th-upload-zone-icon {
            width: 48px;
            height: 48px;
            background: #fef2f2;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }
        .th-upload-zone-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--red);
            fill: none;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .th-upload-zone h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--dark);
        }
        .th-upload-zone p {
            font-size: 13px;
            color: var(--gray);
            margin: 0;
            animation: none;
            max-width: none;
        }

        /* Upload Form (inline) */
        .th-upload-form {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            background: white;
            margin-bottom: 24px;
            display: none;
        }
        .th-upload-form h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--dark);
        }
        .th-upload-form .form-file-name {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .th-upload-form .form-file-name svg {
            width: 16px;
            height: 16px;
            stroke: var(--red);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            flex-shrink: 0;
        }
        .th-form-group { margin-bottom: 14px; }
        .th-form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 6px;
        }
        .th-form-group select,
        .th-form-group input,
        .th-form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
            background: white;
        }
        .th-form-group select:focus,
        .th-form-group input:focus,
        .th-form-group textarea:focus { border-color: var(--red); }
        .th-form-group textarea { resize: vertical; min-height: 70px; }
        .th-form-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        .th-btn {
            padding: 10px 22px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .th-btn-primary {
            background: var(--red);
            color: white;
        }
        .th-btn-primary:hover { background: var(--red-light); }
        .th-btn-primary:disabled { background: #d1d5db; cursor: not-allowed; }
        .th-btn-secondary {
            background: white;
            color: var(--gray);
            border: 1.5px solid #d1d5db;
        }
        .th-btn-secondary:hover { border-color: var(--red); color: var(--red); }

        /* Progress bar */
        .th-progress-bar {
            width: 100%;
            height: 4px;
            background: #f3f4f6;
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
            display: none;
        }
        .th-progress-bar-fill {
            height: 100%;
            background: var(--red);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Category Filter */
        .th-filter-bar {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .th-filter-chip {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            border: 1px solid #e5e7eb;
            background: white;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s;
        }
        .th-filter-chip:hover { border-color: var(--red); color: var(--red); }
        .th-filter-chip.active { background: #fef2f2; color: var(--red); border-color: var(--red); font-weight: 600; }

        /* Item Cards (shared between docs, SOPs) */
        .th-card-list { display: grid; gap: 10px; }
        .th-card {
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            padding: 16px 20px;
            background: white;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .th-card:hover {
            border-color: #e5e7eb;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        }
        .th-card-icon {
            width: 40px;
            height: 40px;
            background: #fef2f2;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .th-card-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--red);
            fill: none;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .th-card-info { flex: 1; min-width: 0; }
        .th-card-info h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .th-card-meta {
            font-size: 12px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .th-card-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: var(--gray);
            text-transform: capitalize;
        }
        .th-card-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .th-icon-btn {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 1.5px solid #e5e7eb;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .th-icon-btn:hover { border-color: var(--red); background: #fef2f2; }
        .th-icon-btn svg {
            width: 15px;
            height: 15px;
            stroke: var(--gray);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .th-icon-btn:hover svg { stroke: var(--red); }
        .th-icon-btn-danger:hover { border-color: #ef4444; background: #fef2f2; }
        .th-icon-btn-danger:hover svg { stroke: #ef4444; }

        /* Empty State */
        .th-empty {
            text-align: center;
            padding: 48px 32px;
            color: var(--gray);
        }
        .th-empty h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        .th-empty p {
            font-size: 14px;
            max-width: none;
            animation: none;
            margin: 0;
        }

        /* Loading Spinner */
        .th-loading {
            text-align: center;
            padding: 48px;
        }
        .th-spinner {
            width: 36px;
            height: 36px;
            border: 3px solid #f3f4f6;
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        /* SOP Detail View */
        .th-sop-detail {
            display: none;
        }
        .th-sop-detail-header {
            margin-bottom: 24px;
        }
        .th-sop-detail-header h2 {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
            color: var(--dark);
        }
        .th-sop-detail-body {
            background: #f9fafb;
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            padding: 24px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.7;
            color: var(--dark);
            margin-bottom: 20px;
        }
        .th-back-link {
            background: none;
            border: none;
            color: var(--red);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            padding: 0;
            margin-bottom: 16px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .th-back-link:hover { text-decoration: underline; }
        .th-back-link svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Technician Stats */
        .th-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        .th-stat-card {
            padding: 18px;
            border-radius: 12px;
            border: 1px solid #f3f4f6;
            background: white;
            text-align: center;
        }
        .th-stat-number {
            font-size: 28px;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -1px;
        }
        .th-stat-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray);
            margin-top: 2px;
        }
        .th-stat-card.stat-interview .th-stat-number { color: #3b82f6; }
        .th-stat-card.stat-active .th-stat-number { color: #10b981; }
        .th-stat-card.stat-terminated .th-stat-number { color: #ef4444; }

        /* Technician Cards */
        .th-tech-card {
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            background: white;
            transition: all 0.2s;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .th-tech-card:hover {
            border-color: #e5e7eb;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        }
        .th-tech-summary {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            cursor: pointer;
        }
        .th-tech-avatar {
            width: 42px;
            height: 42px;
            background: #fef2f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            color: var(--red);
            flex-shrink: 0;
        }
        .th-tech-info { flex: 1; min-width: 0; }
        .th-tech-info h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }
        .th-tech-position {
            font-size: 12px;
            color: var(--gray);
            margin-top: 1px;
        }
        .th-tech-status {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .th-tech-status-interview { background: #eff6ff; color: #3b82f6; }
        .th-tech-status-active { background: #ecfdf5; color: #10b981; }
        .th-tech-status-terminated { background: #fef2f2; color: #ef4444; }
        .th-tech-chevron {
            width: 20px;
            height: 20px;
            stroke: #9ca3af;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .th-tech-card.expanded .th-tech-chevron { transform: rotate(180deg); }

        /* Expanded Checklist */
        .th-tech-detail {
            display: none;
            padding: 0 20px 20px;
            border-top: 1px solid #f3f4f6;
        }
        .th-tech-card.expanded .th-tech-detail { display: block; }
        /* Status select in expanded card */
        .th-status-select {
            padding: 6px 10px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            font-weight: 600;
            outline: none;
            cursor: pointer;
            background: white;
            transition: border-color 0.2s;
        }
        .th-status-select:focus { border-color: var(--red); }

        /* Editable Checklist */
        .th-checklist { list-style: none; padding: 0; margin: 16px 0 0; }
        .th-checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f9fafb;
        }
        .th-checklist-item:last-child { border-bottom: none; }
        .th-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 5px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        .th-checkbox:hover { border-color: #9ca3af; }
        .th-checkbox.checked {
            background: #10b981;
            border-color: #10b981;
        }
        .th-checkbox.checked svg {
            width: 12px;
            height: 12px;
            stroke: white;
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .th-checklist-label {
            font-size: 14px;
            color: var(--dark);
            flex: 1;
            cursor: pointer;
        }
        .th-checklist-item.done .th-checklist-label {
            color: #9ca3af;
            text-decoration: line-through;
        }
        .th-checklist-remove {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            color: #d1d5db;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
            transition: all 0.15s;
        }
        .th-checklist-remove:hover { color: #ef4444; background: #fef2f2; }
        .th-checklist-add {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        .th-checklist-add input {
            flex: 1;
            padding: 6px 10px;
            border: 1.5px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            outline: none;
        }
        .th-checklist-add input:focus { border-color: var(--red); }
        .th-checklist-add button {
            padding: 6px 12px;
            background: var(--dark);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .th-checklist-add button:hover { background: #333; }

        /* Termination info block */
        .th-termination-info {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 12px;
            font-size: 13px;
            color: #991b1b;
        }
        .th-termination-info strong { font-weight: 700; }

        /* Termination modal */
        .th-terminate-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        .th-terminate-overlay.active { display: flex; }
        .th-terminate-box {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 440px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        .th-terminate-box h3 {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 16px;
            color: var(--dark);
        }
        .th-terminate-type-btns {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .th-terminate-type-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .th-terminate-type-btn:hover { border-color: #9ca3af; }
        .th-terminate-type-btn.active { border-color: #ef4444; background: #fef2f2; color: #ef4444; }
        .th-terminate-box textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 16px;
        }
        .th-terminate-box textarea:focus { border-color: var(--red); }
        .th-terminate-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Per-tech documents */
        .th-tech-docs {
            margin-top: 16px;
            border-top: 1px solid #f3f4f6;
            padding-top: 16px;
        }
        .th-tech-docs-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .th-tech-docs-header h5 {
            font-size: 13px;
            font-weight: 700;
            color: var(--dark);
        }
        .th-tech-doc-upload-zone {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 10px;
        }
        .th-tech-doc-upload-zone:hover { border-color: var(--red); color: var(--dark); }
        .th-tech-doc-list { display: flex; flex-direction: column; gap: 6px; }
        .th-tech-doc-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 13px;
        }
        .th-tech-doc-item svg {
            width: 16px;
            height: 16px;
            stroke: var(--gray);
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }
        .th-tech-doc-item span { flex: 1; color: var(--dark); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .th-tech-doc-item small { color: #9ca3af; flex-shrink: 0; }
        .th-tech-doc-item a {
            color: var(--red);
            font-weight: 600;
            text-decoration: none;
            flex-shrink: 0;
        }
        .th-tech-doc-item button {
            background: none;
            border: none;
            color: #d1d5db;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 4px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .th-tech-doc-item button:hover { color: #ef4444; background: #fef2f2; }
        .th-tech-doc-progress {
            height: 4px;
            background: #f3f4f6;
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .th-tech-doc-progress div {
            height: 100%;
            background: var(--red);
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Template editor modal */
        .th-template-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        .th-template-overlay.active { display: flex; }
        .th-template-box {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        .th-template-box h3 {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--dark);
        }
        .th-template-box > p {
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 16px;
            line-height: 1.5;
            max-width: none;
            text-align: left;
        }
        .th-template-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .th-template-item span { flex: 1; font-size: 14px; color: var(--dark); }
        .th-template-item button {
            background: none;
            border: none;
            color: #d1d5db;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .th-template-item button:hover { color: #ef4444; background: #fef2f2; }
        .th-template-add {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            margin-bottom: 20px;
        }
        .th-template-add input {
            flex: 1;
            padding: 8px 12px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            outline: none;
        }
        .th-template-add input:focus { border-color: var(--red); }
        .th-template-add button {
            padding: 8px 16px;
            background: var(--dark);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .th-template-add button:hover { background: #333; }
        .th-template-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .th-tech-notes {
            margin-top: 16px;
        }
        .th-tech-notes label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 6px;
        }
        .th-tech-notes textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            resize: vertical;
            min-height: 60px;
            transition: border-color 0.2s;
        }
        .th-tech-notes textarea:focus { border-color: var(--red); }
        .th-tech-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        /* Confirm Dialog */
        .th-confirm-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }
        .th-confirm-overlay.active { display: flex; }
        .th-confirm-box {
            background: white;
            border-radius: 12px;
            padding: 28px;
            max-width: 360px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
        .th-confirm-box h3 {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        .th-confirm-box p {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 20px;
            max-width: none;
            animation: none;
        }
        .th-confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .th-btn-danger {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s;
        }
        .th-btn-danger:hover { background: #dc2626; }

        /* Toast */
        .th-toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--dark);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .th-toast.show { opacity: 1; transform: translateY(0); }

        /* Metrics Dashboard */
        .metrics-section { margin-bottom: 32px; }
        .metrics-section-title { font-size: 16px; font-weight: 800; color: var(--dark); margin-bottom: 16px; letter-spacing: -0.3px; }
        .metrics-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px; }
        .metrics-card { padding: 18px; border-radius: 12px; border: 1px solid #f3f4f6; background: white; text-align: center; }
        .metrics-card-number { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
        .metrics-card-label { font-size: 12px; font-weight: 500; color: var(--gray); margin-top: 2px; }
        .metrics-total { text-align: right; font-size: 14px; font-weight: 700; color: var(--dark); padding: 8px 0; }
        .metrics-tables-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .metrics-table-wrapper { border: 1px solid #f3f4f6; border-radius: 12px; overflow: hidden; }
        .metrics-table-title { font-size: 13px; font-weight: 700; color: var(--dark); padding: 14px 16px 10px; }
        .metrics-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .metrics-table th { text-align: left; padding: 8px 16px; font-weight: 600; color: var(--gray); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #f3f4f6; background: #fafafa; }
        .metrics-table td { padding: 10px 16px; border-bottom: 1px solid #f9fafb; color: var(--dark); }
        .metrics-table tr:last-child td { border-bottom: none; }
        .metrics-table .rate-good { color: #10b981; font-weight: 600; }
        .metrics-table .rate-mid { color: #d97706; font-weight: 600; }
        .metrics-table .rate-low { color: #ef4444; font-weight: 600; }
        .attrition-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .attrition-card { padding: 18px; border-radius: 12px; border: 1px solid #f3f4f6; background: white; text-align: center; }
        .attrition-card-number { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
        .attrition-card-label { font-size: 12px; font-weight: 500; color: var(--gray); margin-top: 2px; }
        .attrition-quit .attrition-card-number { color: #d97706; }
        .attrition-fired .attrition-card-number { color: #ef4444; }
        .badge-quit { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; background: #fffbeb; color: #d97706; }
        .badge-fired { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; background: #fef2f2; color: #ef4444; }
        .onboarding-bar { width: 60px; height: 6px; background: #f3f4f6; border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 6px; }
        .onboarding-bar-fill { height: 100%; border-radius: 3px; background: #10b981; }
        .th-onboarding-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .th-onboarding-badge.complete { background: #ecfdf5; color: #10b981; }
        .th-onboarding-badge.partial { background: #fffbeb; color: #d97706; }
        .th-onboarding-badge.none { background: #f3f4f6; color: var(--gray); }
        .th-assignment-row { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .th-assignment-row label { font-size: 13px; font-weight: 600; color: var(--dark); white-space: nowrap; }

        @media (max-width: 640px) {
            .techhub-header { padding: 16px 20px; flex-wrap: wrap; gap: 10px; }
            .techhub-header-right { width: 100%; justify-content: flex-end; }
            .techhub-content { padding: 24px 16px; }
            .techhub-tabs { overflow-x: auto; }
            .th-stats { grid-template-columns: repeat(2, 1fr); }
            .th-card { flex-wrap: wrap; }
            .th-card-actions { width: 100%; justify-content: flex-end; }
            .th-tech-summary { flex-wrap: wrap; }
            .th-tech-status { order: -1; }
            .techhub-user-email { display: none; }
            .metrics-cards { grid-template-columns: 1fr; }
            .metrics-tables-row { grid-template-columns: 1fr; }
            .attrition-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- Site Navigation -->
<nav class="site-nav">
    <a href="https://adastrak.com" class="nav-logo-link">
        <img src="logo-full.png" alt="TRAK" class="nav-logo">
    </a>
    <div class="nav-tabs">
        <button class="nav-tab active" id="nav-home">Home</button>
        <button class="nav-tab" id="nav-techhub">Technician Hub</button>
    </div>
</nav>

<!-- Decorative ADAS equipment illustrations -->
<!-- Autel Diagnostic Tablet -->
<div class="deco deco-tablet">
    <svg viewBox="0 0 120 160" xmlns="http://www.w3.org/2000/svg">
        <!-- Tablet body -->
        <rect x="10" y="8" width="100" height="144" rx="10" ry="10"/>
        <!-- Screen -->
        <rect x="18" y="20" width="84" height="108" rx="4" ry="4"/>
        <!-- Home button -->
        <circle cx="60" cy="142" r="5"/>
        <!-- Screen content - diagnostic UI -->
        <line x1="28" y1="40" x2="92" y2="40"/>
        <line x1="28" y1="52" x2="72" y2="52"/>
        <line x1="28" y1="64" x2="82" y2="64"/>
        <!-- Car outline on screen -->
        <path d="M42 85 L48 75 L72 75 L78 85 L82 90 L82 100 L38 100 L38 90 Z"/>
        <!-- Wheels -->
        <circle cx="46" cy="100" r="4"/>
        <circle cx="74" cy="100" r="4"/>
        <!-- Status bar -->
        <rect x="28" y="108" width="20" height="6" rx="2"/>
        <rect x="52" y="108" width="30" height="6" rx="2"/>
    </svg>
</div>

<!-- Windshield Camera Calibration Target -->
<div class="deco deco-target">
    <svg viewBox="0 0 140 160" xmlns="http://www.w3.org/2000/svg">
        <!-- Target board frame -->
        <rect x="10" y="10" width="120" height="90" rx="3" ry="3"/>
        <!-- Inner border -->
        <rect x="18" y="18" width="104" height="74" rx="2" ry="2"/>
        <!-- Crosshair pattern -->
        <line x1="70" y1="18" x2="70" y2="92"/>
        <line x1="18" y1="55" x2="122" y2="55"/>
        <!-- Target circles -->
        <circle cx="70" cy="55" r="16"/>
        <circle cx="70" cy="55" r="8"/>
        <circle cx="70" cy="55" r="3"/>
        <!-- Corner markers -->
        <rect x="22" y="22" width="12" height="12"/>
        <rect x="106" y="22" width="12" height="12"/>
        <rect x="22" y="74" width="12" height="12"/>
        <rect x="106" y="74" width="12" height="12"/>
        <!-- Stand legs -->
        <line x1="50" y1="100" x2="30" y2="155"/>
        <line x1="90" y1="100" x2="110" y2="155"/>
        <line x1="70" y1="100" x2="70" y2="150"/>
        <!-- Crossbar -->
        <line x1="42" y1="125" x2="98" y2="125"/>
    </svg>
</div>

<!-- Radar Reflector Target -->
<div class="deco deco-radar">
    <svg viewBox="0 0 120 130" xmlns="http://www.w3.org/2000/svg">
        <!-- Reflector body - corner reflector shape -->
        <path d="M20 30 L60 10 L100 30 L100 80 L60 100 L20 80 Z"/>
        <!-- Inner facets -->
        <line x1="60" y1="10" x2="60" y2="100"/>
        <line x1="20" y1="55" x2="100" y2="55"/>
        <!-- Radar wave arcs -->
        <path d="M60 40 Q45 55 60 70" fill="none"/>
        <path d="M60 40 Q75 55 60 70" fill="none"/>
        <path d="M55 35 Q35 55 55 75" fill="none"/>
        <path d="M65 35 Q85 55 65 75" fill="none"/>
        <!-- Mounting pole -->
        <line x1="60" y1="100" x2="60" y2="125"/>
        <!-- Base -->
        <ellipse cx="60" cy="125" rx="20" ry="5"/>
    </svg>
</div>

<!-- Target Stand with Wheel Alignment -->
<div class="deco deco-stand">
    <svg viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
        <!-- Vertical pole -->
        <line x1="50" y1="10" x2="50" y2="110"/>
        <!-- Horizontal arm -->
        <line x1="20" y1="25" x2="80" y2="25"/>
        <!-- Mounting bracket -->
        <rect x="40" y="15" width="20" height="20" rx="2"/>
        <!-- Height adjustment marks -->
        <line x1="46" y1="45" x2="54" y2="45"/>
        <line x1="46" y1="55" x2="54" y2="55"/>
        <line x1="46" y1="65" x2="54" y2="65"/>
        <line x1="46" y1="75" x2="54" y2="75"/>
        <!-- Clamp knob -->
        <circle cx="58" cy="85" r="4"/>
        <!-- Tripod base -->
        <line x1="50" y1="110" x2="15" y2="135"/>
        <line x1="50" y1="110" x2="85" y2="135"/>
        <line x1="50" y1="110" x2="50" y2="138"/>
        <!-- Feet -->
        <circle cx="15" cy="135" r="3"/>
        <circle cx="85" cy="135" r="3"/>
        <circle cx="50" cy="138" r="3"/>
    </svg>
</div>

<div class="container">
    <a href="https://adastrak.com">
        <img src="logo-full.png" alt="TRAK" class="logo">
    </a>

    <h1>Built by calibrators, <span>for calibrators.</span></h1>

    <p>TRAK is the operating system for ADAS calibration businesses and collision centers performing calibrations. It unifies scheduling, required calibration reporting, workflow and documentation, billing, analytics, and customer access into a single platform built specifically for the calibration industry.</p>

    <div class="ctas">
        <a href="https://calendly.com/will-adastrak/30min" class="btn btn-primary">Book a Demo</a>
        <a href="tel:+18474719455" class="btn btn-outline">Call (847) 471-9455</a>
    </div>

    <div class="features">
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
            <h3>Scheduling</h3>
            <p>Manage appointments, technician availability, and bay schedules from one calendar.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
            <h3>Calibration Reports</h3>
            <p>Auto-generate required calibration documentation ready for insurers and shops.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
            <h3>Workflow</h3>
            <p>Track every job from intake to completion with real-time status updates.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
            <h3>Billing</h3>
            <p>Invoice customers, track payments, and manage pricing by calibration type.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg></div>
            <h3>Analytics</h3>
            <p>Revenue, turnaround times, technician performance, and shop-level insights.</p>
        </div>
        <div class="feature-card" id="customer-portal-trigger" style="cursor:pointer">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
            <h3>Customer Portal</h3>
            <p>Give shops and insurers real-time visibility into job status and reports.</p>
        </div>
    </div>

    <div class="divider"></div>
    <p class="footer-contact">New York, NY &middot; <a href="mailto:team@get-trak.com">team@get-trak.com</a></p>
    <p class="footer-text">&copy; 2026 TRAK &middot; <a href="https://adastrak.com">adastrak.com</a></p>
    <p class="footer-links"><a href="https://adastrak.com">Privacy Policy</a> &middot; <a href="https://adastrak.com">Terms of Service</a></p>
</div>

<!-- Password Modal -->
<div class="password-overlay" id="password-overlay">
    <div class="password-modal">
        <h2>Enter Access Code</h2>
        <p class="modal-subtitle">This area is restricted.</p>
        <input type="password" id="password-input" placeholder="Access code" autocomplete="off">
        <p class="password-error" id="password-error">Incorrect access code</p>
        <button class="modal-btn" id="password-submit">Submit</button>
        <button class="modal-cancel" id="password-cancel">Cancel</button>
    </div>
</div>

<!-- Mapper Section -->
<div class="mapper-section" id="mapper-section">
    <div class="mapper-header">
        <div class="mapper-header-left">
            <img src="logo-full.png" alt="TRAK">
            <h1>Mapper</h1>
        </div>
        <div class="mapper-header-right">
            <button class="mapper-history-btn" id="mapper-history-btn">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                History
                <span class="history-badge" id="history-badge" style="display:none">0</span>
            </button>
            <button class="mapper-back" id="mapper-back">Back to Home</button>
        </div>
    </div>
    <div class="mapper-content">
        <div id="upload-section">
            <div class="upload-zone" id="upload-zone">
                <div class="upload-zone-icon">
                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <h3>Upload Collision Repair Estimate</h3>
                <p>Drag & drop a PDF estimate, or click to browse</p>
                <span class="browse-btn">Browse Files</span>
                <input type="file" id="pdf-file-input" accept=".pdf" style="display:none">
            </div>
        </div>
        <div class="processing-state" id="processing-state">
            <div class="processing-spinner"></div>
            <p>Analyzing estimate for ADAS calibration requirements...</p>
        </div>
        <div class="results-section" id="results-section"></div>
        <div class="history-section" id="history-section"></div>
    </div>
</div>

<!-- Technician Hub Login Modal -->
<div class="login-overlay" id="login-overlay">
    <div class="login-modal">
        <h2>Technician Hub</h2>
        <p class="modal-subtitle">Sign in with your team account.</p>
        <input type="email" id="login-email" placeholder="Email" autocomplete="email">
        <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
        <p class="login-error" id="login-error">Invalid email or password</p>
        <button class="modal-btn" id="login-submit">Sign In</button>
        <button class="modal-cancel" id="login-cancel">Cancel</button>
    </div>
</div>

<!-- Technician Hub Section -->
<div class="techhub-section" id="techhub-section">
    <div class="techhub-header">
        <div class="techhub-header-left">
            <img src="adas-safe-logo.png" alt="ADAS Safe">
            <h1>Technician Hub</h1>
        </div>
        <div class="techhub-header-right">
            <span class="techhub-user-email" id="techhub-user-email"></span>
            <button class="techhub-signout" id="techhub-signout">Sign Out</button>
            <button class="techhub-back" id="techhub-back">Back to Home</button>
        </div>
    </div>
    <div class="techhub-content" style="max-width:960px">
        <div class="techhub-tabs">
            <button class="techhub-tab active" data-tab="technicians">Technicians</button>
            <button class="techhub-tab" data-tab="sops">SOPs</button>
            <button class="techhub-tab" data-tab="documents">Documents</button>
            <button class="techhub-tab" data-tab="metrics">Metrics</button>
        </div>

        <!-- Documents Panel -->
        <div class="techhub-panel" id="panel-documents">
            <div class="th-upload-zone" id="th-doc-upload-zone">
                <div class="th-upload-zone-icon">
                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <h3>Upload a Document</h3>
                <p>Drag & drop a file, or click to browse</p>
                <input type="file" id="th-doc-file-input" style="display:none" accept=".pdf,.docx,.xlsx,.png,.jpg,.jpeg">
            </div>
            <div class="th-upload-form" id="th-doc-upload-form">
                <h3>Upload Document</h3>
                <div class="form-file-name" id="th-doc-form-filename">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    <span id="th-doc-form-filename-text"></span>
                </div>
                <div class="th-form-group">
                    <label>Category</label>
                    <select id="th-doc-category">
                        <option value="oem-statements">OEM Statements</option>
                        <option value="training">Training</option>
                        <option value="safety">Safety</option>
                        <option value="forms">Forms</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="th-form-group">
                    <label>Description (optional)</label>
                    <textarea id="th-doc-description" placeholder="Add a note about this document..."></textarea>
                </div>
                <div class="th-progress-bar" id="th-doc-progress">
                    <div class="th-progress-bar-fill" id="th-doc-progress-fill"></div>
                </div>
                <div class="th-form-actions">
                    <button class="th-btn th-btn-primary" id="th-doc-upload-btn">Upload</button>
                    <button class="th-btn th-btn-secondary" id="th-doc-cancel-btn">Cancel</button>
                </div>
            </div>
            <div class="th-filter-bar" id="th-doc-filter-bar">
                <button class="th-filter-chip active" data-filter="all">All</button>
                <button class="th-filter-chip" data-filter="oem-statements">OEM Statements</button>
                <button class="th-filter-chip" data-filter="training">Training</button>
                <button class="th-filter-chip" data-filter="safety">Safety</button>
                <button class="th-filter-chip" data-filter="forms">Forms</button>
                <button class="th-filter-chip" data-filter="other">Other</button>
            </div>
            <div id="th-doc-list"></div>
        </div>

        <!-- SOPs Panel -->
        <div class="techhub-panel" id="panel-sops">
            <div id="th-sop-list-view">
                <div style="display:flex;gap:10px;margin-bottom:24px;flex-wrap:wrap">
                    <button class="th-btn th-btn-primary" id="th-sop-create-btn">Create SOP</button>
                    <button class="th-btn th-btn-secondary" id="th-sop-upload-btn">Upload SOP PDF</button>
                    <input type="file" id="th-sop-file-input" style="display:none" accept=".pdf">
                </div>
                <div id="th-sop-list"></div>
            </div>
            <div class="th-sop-detail" id="th-sop-detail"></div>
            <div class="th-upload-form" id="th-sop-form" style="display:none">
                <h3 id="th-sop-form-title">Create SOP</h3>
                <div class="th-form-group">
                    <label>Title</label>
                    <input type="text" id="th-sop-title" placeholder="e.g. Forward Camera Static Calibration">
                </div>
                <div class="th-form-group">
                    <label>Category</label>
                    <select id="th-sop-category">
                        <option value="calibration">Calibration</option>
                        <option value="safety">Safety</option>
                        <option value="equipment">Equipment</option>
                        <option value="customer">Customer</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <div class="th-form-group">
                    <label>Description / Procedure</label>
                    <textarea id="th-sop-description" placeholder="Write the full SOP content here..." style="min-height:160px"></textarea>
                </div>
                <div class="th-form-group" id="th-sop-file-group" style="display:none">
                    <label>Attached PDF</label>
                    <div class="form-file-name">
                        <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        <span id="th-sop-file-name-text"></span>
                    </div>
                </div>
                <div class="th-progress-bar" id="th-sop-progress">
                    <div class="th-progress-bar-fill" id="th-sop-progress-fill"></div>
                </div>
                <div class="th-form-actions">
                    <button class="th-btn th-btn-primary" id="th-sop-save-btn">Save SOP</button>
                    <button class="th-btn th-btn-secondary" id="th-sop-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Technicians Panel -->
        <div class="techhub-panel active" id="panel-technicians">
            <div class="th-stats" id="th-tech-stats"></div>
            <div class="th-filter-bar" id="th-tech-filter-bar" style="margin-bottom:16px">
                <button class="th-filter-chip active" data-filter="all">All</button>
                <button class="th-filter-chip" data-filter="interview">Interview</button>
                <button class="th-filter-chip" data-filter="active">Active</button>
                <button class="th-filter-chip" data-filter="terminated">Terminated</button>
            </div>
            <div style="margin-bottom:24px;display:flex;gap:10px;flex-wrap:wrap">
                <button class="th-btn th-btn-primary" id="th-add-tech-btn">Add Technician</button>
                <button class="th-btn th-btn-secondary" id="th-manage-checklist-btn" title="Manage Checklist Template" style="display:flex;align-items:center;gap:6px">
                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    Manage Checklist
                </button>
            </div>
            <div class="th-upload-form" id="th-add-tech-form" style="display:none">
                <h3>Add Technician</h3>
                <div class="th-form-group">
                    <label>Full Name</label>
                    <input type="text" id="th-tech-name" placeholder="e.g. John Smith">
                </div>
                <div class="th-form-group">
                    <label>Email (optional)</label>
                    <input type="email" id="th-tech-email" placeholder="john@adassafe.com">
                </div>
                <div class="th-form-group">
                    <label>Phone (optional)</label>
                    <input type="tel" id="th-tech-phone" placeholder="(555) 123-4567">
                </div>
                <div class="th-form-group">
                    <label>Position</label>
                    <input type="text" id="th-tech-position" placeholder="e.g. ADAS Calibration Technician">
                </div>
                <div class="th-form-group">
                    <label>Interview Date</label>
                    <input type="date" id="th-tech-interview-date">
                </div>
                <div class="th-form-group">
                    <label>Notes (optional)</label>
                    <textarea id="th-tech-init-notes" placeholder="Any initial notes about this candidate..."></textarea>
                </div>
                <div class="th-form-actions">
                    <button class="th-btn th-btn-primary" id="th-tech-save-btn">Add Technician</button>
                    <button class="th-btn th-btn-secondary" id="th-tech-cancel-btn">Cancel</button>
                </div>
            </div>
            <div id="th-tech-list"></div>
        </div>

        <!-- Metrics Panel -->
        <div class="techhub-panel" id="panel-metrics">
            <div id="metrics-content">
                <div class="th-loading"><div class="th-spinner"></div><p style="font-size:13px;color:var(--gray);animation:none;max-width:none">Loading metrics...</p></div>
            </div>
        </div>

    </div>
</div>

<!-- Confirm Dialog -->
<div class="th-confirm-overlay" id="th-confirm-overlay">
    <div class="th-confirm-box">
        <h3 id="th-confirm-title">Are you sure?</h3>
        <p id="th-confirm-message">This action cannot be undone.</p>
        <div class="th-confirm-actions">
            <button class="th-btn-danger" id="th-confirm-yes">Delete</button>
            <button class="th-btn th-btn-secondary" id="th-confirm-no">Cancel</button>
        </div>
    </div>
</div>

<!-- Termination Modal -->
<div class="th-terminate-overlay" id="th-terminate-overlay">
    <div class="th-terminate-box">
        <h3>Terminate Technician</h3>
        <label style="display:block;font-size:13px;font-weight:600;color:var(--dark);margin-bottom:8px">Type</label>
        <div class="th-terminate-type-btns">
            <button class="th-terminate-type-btn active" data-type="quit">Quit</button>
            <button class="th-terminate-type-btn" data-type="fired">Fired</button>
        </div>
        <label style="display:block;font-size:13px;font-weight:600;color:var(--dark);margin-bottom:6px">Reason (optional)</label>
        <textarea id="th-terminate-reason" placeholder="Provide a reason for termination..."></textarea>
        <div class="th-terminate-actions">
            <button class="th-btn-danger" id="th-terminate-confirm">Confirm Termination</button>
            <button class="th-btn th-btn-secondary" id="th-terminate-cancel">Cancel</button>
        </div>
    </div>
</div>

<!-- Checklist Template Modal -->
<div class="th-template-overlay" id="th-template-overlay">
    <div class="th-template-box">
        <h3>Manage Checklist Template</h3>
        <p>These items will be added to every new technician's checklist. Changes only affect future technicians.</p>
        <div id="th-template-items"></div>
        <div class="th-template-add">
            <input type="text" id="th-template-new-item" placeholder="New checklist item...">
            <button id="th-template-add-btn">Add</button>
        </div>
        <div class="th-template-actions">
            <button class="th-btn th-btn-primary" id="th-template-save-btn">Save Template</button>
            <button class="th-btn th-btn-secondary" id="th-template-close-btn">Close</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="th-toast" id="th-toast"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const CALIBRATION_MAP = [
    {
        id: 'forward-camera',
        name: 'Forward Camera Calibration',
        calibrationType: 'Static & Dynamic',
        priority: 'high',
        description: 'The forward-facing camera must be recalibrated to ensure proper operation of lane departure warning, automatic emergency braking, and adaptive cruise control.',
        triggers: [
            ['windshield', 'w/shield', 'wshield', 'w/s glass'],
            ['forward camera', 'front camera', 'adas camera', 'camera bracket', 'camera assy'],
            ['rearview mirror', 'rear view mirror', 'interior mirror', 'inside mirror', 'mirror assy inside']
        ]
    },
    {
        id: 'front-radar',
        name: 'Front Radar Sensor Calibration',
        calibrationType: 'Static',
        priority: 'high',
        description: 'The front radar sensor must be recalibrated for adaptive cruise control and automatic emergency braking to function properly.',
        triggers: [
            ['front bumper', 'frt bumper', 'bumper cover frt', 'bumper assy frt', 'front fascia', 'frt fascia', 'bumper fascia frt'],
            ['grille', 'grill', 'radiator grille', 'upper grille', 'lower grille'],
            ['front radar', 'radar sensor', 'radar bracket', 'radar module', 'distance sensor'],
            ['radiator support', 'rad support', 'radiator core support', 'core support'],
            ['condenser', 'a/c condenser'],
            ['front emblem', 'front badge']
        ]
    },
    {
        id: 'blind-spot',
        name: 'Blind Spot Monitor Calibration',
        calibrationType: 'Dynamic',
        priority: 'high',
        description: 'Blind spot monitoring sensors must be recalibrated to accurately detect vehicles in adjacent lanes.',
        triggers: [
            ['rear bumper', 'rr bumper', 'bumper cover rr', 'bumper assy rr', 'rear fascia', 'rr fascia', 'bumper fascia rr'],
            ['quarter panel', 'qtr panel', 'quarter pnl', 'qtr pnl'],
            ['blind spot', 'bsm', 'blind spot sensor', 'blind spot monitor', 'blind spot radar'],
            ['rear body panel', 'body panel rr'],
            ['liftgate', 'tailgate', 'trunk lid', 'back door']
        ]
    },
    {
        id: 'rear-parking',
        name: 'Parking Sensor Calibration',
        calibrationType: 'Static',
        priority: 'medium',
        description: 'Parking sensors and/or rear cross-traffic alert sensors must be recalibrated after bumper or sensor removal.',
        triggers: [
            ['parking sensor', 'park sensor', 'ultrasonic sensor', 'park assist', 'sonar sensor'],
            ['rear cross traffic', 'rcta', 'cross traffic alert']
        ]
    },
    {
        id: 'rear-camera',
        name: 'Rear / Surround View Camera Calibration',
        calibrationType: 'Static',
        priority: 'medium',
        description: 'Rear or surround view cameras must be recalibrated to ensure accurate guidelines and object detection.',
        triggers: [
            ['rear camera', 'backup camera', 'back up camera', 'reverse camera', 'rearview camera'],
            ['surround view', 'surround camera', '360 camera', 'around view']
        ]
    },
    {
        id: 'headlight-aiming',
        name: 'Headlight Aiming',
        calibrationType: 'Static',
        priority: 'medium',
        description: 'Headlights must be aimed after replacement or structural repair that may affect headlight positioning.',
        triggers: [
            ['headlamp', 'headlight', 'head lamp', 'head light'],
            ['headlamp bracket', 'headlight bracket', 'headlamp mount'],
            ['headlamp assy', 'headlight assy', 'headlamp assembly', 'headlight assembly']
        ]
    },
    {
        id: 'steering-angle',
        name: 'Steering Angle Sensor Calibration',
        calibrationType: 'Reset / Initialize',
        priority: 'high',
        description: 'The steering angle sensor must be recalibrated to ensure proper function of electronic stability control and ADAS features.',
        triggers: [
            ['wheel alignment', 'four wheel alignment', '4 wheel alignment', 'thrust angle alignment', 'alignment check'],
            ['steering column', 'steering gear', 'steering rack', 'rack and pinion', 'rack & pinion', 'power steering'],
            ['steering angle sensor', 'clock spring', 'clockspring', 'spiral cable'],
            ['tie rod', 'tierod', 'tie-rod', 'inner tie rod', 'outer tie rod'],
            ['subframe', 'sub frame', 'front subframe', 'engine cradle', 'front crossmember']
        ]
    },
    {
        id: 'side-mirror-sensor',
        name: 'Side Mirror / Lane Change Assist Calibration',
        calibrationType: 'Dynamic',
        priority: 'medium',
        description: 'Side mirror-integrated sensors may require recalibration for blind spot and lane change assist systems.',
        triggers: [
            ['side mirror', 'door mirror', 'outside mirror', 'o/s mirror', 'mirror assy door', 'mirror assembly door', 'power mirror']
        ]
    },
    {
        id: 'occupant-classification',
        name: 'Occupant Classification System Calibration',
        calibrationType: 'Static',
        priority: 'medium',
        description: 'The occupant classification system must be recalibrated after seat or airbag sensor removal to ensure proper airbag deployment.',
        triggers: [
            ['occupant sensor', 'occupant classification', 'weight sensor', 'seat sensor', 'seat pressure'],
            ['front seat', 'seat cushion', 'seat frame', 'seat track', 'seat assy'],
            ['airbag', 'air bag', 'srs module', 'supplemental restraint']
        ]
    },
    {
        id: 'ride-height',
        name: 'Ride Height / Suspension Calibration',
        calibrationType: 'Static',
        priority: 'medium',
        description: 'Ride height sensors and adaptive suspension must be recalibrated after suspension component replacement.',
        triggers: [
            ['ride height', 'height sensor', 'level sensor'],
            ['strut', 'strut assy', 'shock absorber', 'coil spring', 'air spring', 'air suspension'],
            ['control arm', 'lower arm', 'upper arm', 'trailing arm']
        ]
    }
];

const VEHICLE_MAKES = ['Toyota','Honda','Ford','Chevrolet','Chevy','Nissan','Hyundai','Kia','Subaru','Mazda','BMW','Mercedes','Audi','Volkswagen','VW','Lexus','Acura','Infiniti','Volvo','Jeep','Dodge','Ram','Chrysler','GMC','Buick','Cadillac','Lincoln','Tesla','Porsche','Land Rover','Range Rover','Jaguar','Genesis','Rivian','Lucid','Mitsubishi','Mini','Fiat','Alfa Romeo','Maserati','Bentley','Rolls Royce','Polestar','Scion','Saturn','Pontiac'];

// === Firebase Init ===
var firebaseConfig = {
    apiKey: "AIzaSyC2pCgGNawbDFnBu1oXlnk4jaG464a7po8",
    authDomain: "technician-hub.firebaseapp.com",
    projectId: "technician-hub",
    storageBucket: "technician-hub.firebasestorage.app",
    messagingSenderId: "829944081206",
    appId: "1:829944081206:web:4bb3c30d0322a1c254a197"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();
var auth = firebase.auth();
var storage = firebase.storage();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

// DOM refs
const passwordOverlay = document.getElementById('password-overlay');
const passwordInput = document.getElementById('password-input');
const passwordError = document.getElementById('password-error');
const mapperSection = document.getElementById('mapper-section');
const uploadZone = document.getElementById('upload-zone');
const pdfFileInput = document.getElementById('pdf-file-input');
const processingState = document.getElementById('processing-state');
const resultsSection = document.getElementById('results-section');
const uploadSection = document.getElementById('upload-section');
const historySection = document.getElementById('history-section');
const historyBadge = document.getElementById('history-badge');
const techHubSection = document.getElementById('techhub-section');
const loginOverlay = document.getElementById('login-overlay');
const loginEmail = document.getElementById('login-email');
const loginPassword = document.getElementById('login-password');
const loginError = document.getElementById('login-error');

// === Firebase Auth State ===
var thUser = null;
var isDirectTechHub = window.location.hash === '#techhub';

// If direct link, hide TRAK content immediately
if (isDirectTechHub) {
    document.querySelector('.container').style.display = 'none';
    document.querySelector('.site-nav').style.display = 'none';
    var decos = document.querySelectorAll('.deco');
    for (var di = 0; di < decos.length; di++) decos[di].style.display = 'none';
}

auth.onAuthStateChanged(function(user) {
    thUser = user;
    if (user) {
        document.getElementById('techhub-user-email').textContent = user.email;
    }
    if (isDirectTechHub) {
        if (user) {
            openTechHub();
        } else {
            showLoginModal(true);
        }
    }
});

// Open password modal (Mapper only now)
function showPasswordModal() {
    passwordOverlay.style.display = 'flex';
    requestAnimationFrame(function() {
        passwordOverlay.classList.add('active');
        passwordInput.focus();
    });
}

// Open password modal from Customer Portal card
document.getElementById('customer-portal-trigger').addEventListener('click', function() {
    showPasswordModal();
});

// Technician Hub nav tab -> Firebase login
document.getElementById('nav-techhub').addEventListener('click', function() {
    if (thUser) {
        openTechHub();
    } else {
        showLoginModal();
    }
});

// Home nav tab
document.getElementById('nav-home').addEventListener('click', function() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

// Technician Hub back button (keeps session alive)
document.getElementById('techhub-back').addEventListener('click', function() {
    techHubSection.style.display = 'none';
    document.body.style.overflow = '';
});

// Sign out
document.getElementById('techhub-signout').addEventListener('click', function() {
    auth.signOut().then(function() {
        techHubSection.style.display = 'none';
        document.body.style.overflow = '';
        thUser = null;
    });
});

// === Login Modal ===
function showLoginModal(fullscreen) {
    if (fullscreen) loginOverlay.classList.add('fullscreen');
    loginOverlay.style.display = 'flex';
    requestAnimationFrame(function() {
        loginOverlay.classList.add('active');
        loginEmail.focus();
    });
}

function closeLoginModal() {
    if (isDirectTechHub) {
        // Go to the main TRAK page instead of showing blank
        window.location.href = window.location.pathname;
        return;
    }
    loginOverlay.classList.remove('active');
    setTimeout(function() {
        loginOverlay.style.display = 'none';
        loginOverlay.classList.remove('fullscreen');
        loginEmail.value = '';
        loginPassword.value = '';
        loginError.style.display = 'none';
    }, 300);
}

document.getElementById('login-submit').addEventListener('click', doLogin);
loginPassword.addEventListener('keydown', function(e) { if (e.key === 'Enter') doLogin(); });
loginEmail.addEventListener('keydown', function(e) { if (e.key === 'Enter') loginPassword.focus(); });

function doLogin() {
    var email = loginEmail.value.trim();
    var pass = loginPassword.value;
    if (!email || !pass) {
        loginError.textContent = 'Please enter email and password';
        loginError.style.display = 'block';
        return;
    }
    document.getElementById('login-submit').disabled = true;
    document.getElementById('login-submit').textContent = 'Signing in...';
    auth.signInWithEmailAndPassword(email, pass).then(function() {
        // Hide modal directly (don't use closeLoginModal which redirects on #techhub cancel)
        loginOverlay.classList.remove('active', 'fullscreen');
        loginOverlay.style.display = 'none';
        loginEmail.value = '';
        loginPassword.value = '';
        loginError.style.display = 'none';
        openTechHub();
    }).catch(function(err) {
        loginError.textContent = err.code === 'auth/invalid-credential' ? 'Invalid email or password' :
            err.code === 'auth/too-many-requests' ? 'Too many attempts. Try again later.' :
            err.message;
        loginError.style.display = 'block';
        loginPassword.classList.add('shake');
        setTimeout(function() { loginPassword.classList.remove('shake'); }, 400);
    }).finally(function() {
        document.getElementById('login-submit').disabled = false;
        document.getElementById('login-submit').textContent = 'Sign In';
    });
}

document.getElementById('login-cancel').addEventListener('click', closeLoginModal);
loginOverlay.addEventListener('click', function(e) {
    if (e.target === loginOverlay) closeLoginModal();
});

function openTechHub() {
    techHubSection.style.display = 'block';
    document.body.style.overflow = 'hidden';
    // Load the active tab's data
    loadActiveTabData();
}

// === Password Modal (Mapper only) ===
document.getElementById('password-submit').addEventListener('click', checkPassword);
passwordInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') checkPassword();
});

function checkPassword() {
    if (passwordInput.value === 'trak1') {
        closePasswordModal();
        openMapper();
    } else {
        passwordInput.classList.add('shake');
        passwordError.style.display = 'block';
        setTimeout(function() { passwordInput.classList.remove('shake'); }, 400);
    }
}

document.getElementById('password-cancel').addEventListener('click', closePasswordModal);
passwordOverlay.addEventListener('click', function(e) {
    if (e.target === passwordOverlay) closePasswordModal();
});

function closePasswordModal() {
    passwordOverlay.classList.remove('active');
    setTimeout(function() {
        passwordOverlay.style.display = 'none';
        passwordInput.value = '';
        passwordError.style.display = 'none';
    }, 300);
}

// Mapper open/close
function openMapper() {
    mapperSection.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

document.getElementById('mapper-back').addEventListener('click', closeMapper);

function closeMapper() {
    mapperSection.style.display = 'none';
    document.body.style.overflow = '';
    resetMapper();
}

function resetMapper() {
    uploadSection.style.display = 'block';
    processingState.style.display = 'none';
    resultsSection.style.display = 'none';
    historySection.style.display = 'none';
    resultsSection.innerHTML = '';
    pdfFileInput.value = '';
    // Reset processing state in case of prior error
    processingState.innerHTML = '<div class="processing-spinner"></div><p>Analyzing estimate for ADAS calibration requirements...</p>';
}

// File upload
uploadZone.addEventListener('click', function() { pdfFileInput.click(); });

uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});
uploadZone.addEventListener('dragleave', function() {
    uploadZone.classList.remove('dragover');
});
uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    var file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') processFile(file);
});
pdfFileInput.addEventListener('change', function() {
    if (this.files[0]) processFile(this.files[0]);
});

// PDF Processing
async function processFile(file) {
    uploadSection.style.display = 'none';
    processingState.style.display = 'block';

    try {
        var arrayBuffer = await file.arrayBuffer();
        var pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        var fullText = '';

        for (var i = 1; i <= pdf.numPages; i++) {
            var page = await pdf.getPage(i);
            var textContent = await page.getTextContent();
            var pageText = textContent.items.map(function(item) { return item.str; }).join(' ');
            fullText += pageText + '\n';
        }

        var results = analyzeEstimate(fullText);
        displayResults(results, file.name);
    } catch (err) {
        processingState.innerHTML =
            '<div style="text-align:center;padding:48px">' +
            '<p style="color:var(--red);font-weight:600;margin-bottom:12px;max-width:none;animation:none">Error processing PDF</p>' +
            '<p style="color:var(--gray);font-size:14px;max-width:none;animation:none">' + (err.message || 'Could not read the PDF file.') + '</p>' +
            '<button onclick="resetMapper()" style="margin-top:20px;padding:10px 24px;background:var(--red);color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit">Try Again</button>' +
            '</div>';
    }
}

// Analysis engine
function analyzeEstimate(text) {
    var lowerText = text.toLowerCase();
    var lines = text.split(/\n/).filter(function(l) { return l.trim(); });
    var foundCalibrations = [];
    var vehicleInfo = extractVehicleInfo(text);

    for (var m = 0; m < CALIBRATION_MAP.length; m++) {
        var mapping = CALIBRATION_MAP[m];
        var matchedTriggers = [];

        for (var t = 0; t < mapping.triggers.length; t++) {
            var keywordGroup = mapping.triggers[t];
            for (var k = 0; k < keywordGroup.length; k++) {
                var keyword = keywordGroup[k];
                if (lowerText.indexOf(keyword.toLowerCase()) !== -1) {
                    var matchLine = findMatchingLine(lines, keyword);
                    if (matchedTriggers.indexOf(matchLine) === -1) {
                        matchedTriggers.push(matchLine);
                    }
                }
            }
        }

        if (matchedTriggers.length > 0) {
            foundCalibrations.push({
                id: mapping.id,
                name: mapping.name,
                calibrationType: mapping.calibrationType,
                priority: mapping.priority,
                description: mapping.description,
                matchedTriggers: matchedTriggers
            });
        }
    }

    return { calibrations: foundCalibrations, vehicleInfo: vehicleInfo };
}

function extractVehicleInfo(text) {
    var yearMatch = text.match(/\b(19[9]\d|20[0-2]\d)\b/);
    var vinMatch = text.match(/\b[A-HJ-NPR-Z0-9]{17}\b/);
    var foundMake = '';
    var lowerText = text.toLowerCase();
    for (var i = 0; i < VEHICLE_MAKES.length; i++) {
        if (lowerText.indexOf(VEHICLE_MAKES[i].toLowerCase()) !== -1) {
            foundMake = VEHICLE_MAKES[i];
            break;
        }
    }
    return {
        year: yearMatch ? yearMatch[0] : '',
        make: foundMake,
        vin: vinMatch ? vinMatch[0] : ''
    };
}

function findMatchingLine(lines, keyword) {
    var lower = keyword.toLowerCase();
    for (var i = 0; i < lines.length; i++) {
        if (lines[i].toLowerCase().indexOf(lower) !== -1) {
            return lines[i].trim().substring(0, 120);
        }
    }
    return keyword;
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function displayResults(results, fileName) {
    processingState.style.display = 'none';
    resultsSection.style.display = 'block';

    var cals = results.calibrations;
    var v = results.vehicleInfo;
    var vehicleStr = [v.year, v.make].filter(Boolean).join(' ');

    var html = '<div class="results-header">';
    html += '<h2>Required ADAS Calibrations</h2>';
    if (vehicleStr) {
        html += '<p class="results-vehicle">' + escapeHtml(vehicleStr) + (v.vin ? ' &middot; VIN: ' + escapeHtml(v.vin) : '') + '</p>';
    }
    html += '<p class="results-file">' + escapeHtml(fileName) + '</p>';

    if (cals.length > 0) {
        html += '<span class="results-summary">' + cals.length + ' calibration' + (cals.length !== 1 ? 's' : '') + ' identified</span>';
        html += '</div>';
        html += '<div class="results-grid">';

        var priorityOrder = { high: 0, medium: 1, low: 2 };
        cals.sort(function(a, b) { return (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2); });

        for (var i = 0; i < cals.length; i++) {
            var cal = cals[i];
            html += '<div class="calibration-card">';
            html += '<div class="cal-priority cal-priority-' + cal.priority + '"></div>';
            html += '<div class="cal-info">';
            html += '<div class="cal-type">' + escapeHtml(cal.calibrationType) + '</div>';
            html += '<h3>' + escapeHtml(cal.name) + '</h3>';
            html += '<p>' + escapeHtml(cal.description) + '</p>';
            html += '<div class="cal-triggers">';
            for (var j = 0; j < cal.matchedTriggers.length; j++) {
                html += '<span>' + escapeHtml(cal.matchedTriggers[j]) + '</span>';
            }
            html += '</div></div></div>';
        }
        html += '</div>';
    } else {
        html += '</div>';
        html += '<div class="no-calibrations">';
        html += '<h3>No ADAS calibrations identified</h3>';
        html += '<p>No common ADAS calibration triggers were found in this estimate. This does not necessarily mean no calibrations are required &mdash; always verify with OEM procedures.</p>';
        html += '</div>';
    }

    html += '<div class="results-actions">';
    if (cals.length > 0) {
        html += '<button class="btn-download-pdf" onclick="downloadCurrentPDF()"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Download PDF Report</button>';
    }
    html += '<button onclick="resetMapper()">Upload Another Estimate</button>';
    html += '</div>';

    // Store current results for PDF download
    window._currentReport = { calibrations: cals, vehicleInfo: v, fileName: fileName };

    resultsSection.innerHTML = html;

    // Save to history (skip if we're viewing a past report)
    if (!results._fromHistory) {
        saveToHistory(results, fileName);
    }
}

// --- History ---
var HISTORY_KEY = 'trak_mapper_history';

function getHistory() {
    try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    } catch (e) { return []; }
}

function saveToHistory(results, fileName) {
    var history = getHistory();
    var entry = {
        id: Date.now(),
        date: new Date().toISOString(),
        fileName: fileName,
        vehicleInfo: results.vehicleInfo,
        calibrations: results.calibrations
    };
    history.unshift(entry);
    // Keep last 50 reports
    if (history.length > 50) history = history.slice(0, 50);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    updateHistoryBadge();
}

function updateHistoryBadge() {
    var count = getHistory().length;
    if (count > 0) {
        historyBadge.textContent = count;
        historyBadge.style.display = 'inline-flex';
    } else {
        historyBadge.style.display = 'none';
    }
}

function showHistory() {
    uploadSection.style.display = 'none';
    processingState.style.display = 'none';
    resultsSection.style.display = 'none';
    historySection.style.display = 'block';

    var history = getHistory();
    var html = '<div class="history-header">';
    html += '<h2>Report History</h2>';
    if (history.length > 0) {
        html += '<button class="history-clear-btn" onclick="clearHistory()">Clear All</button>';
    }
    html += '</div>';

    if (history.length === 0) {
        html += '<div class="history-empty">';
        html += '<h3>No reports yet</h3>';
        html += '<p>Upload a collision repair estimate and your results will appear here.</p>';
        html += '</div>';
    } else {
        html += '<div class="history-list">';
        for (var i = 0; i < history.length; i++) {
            var entry = history[i];
            var v = entry.vehicleInfo || {};
            var vehicleStr = [v.year, v.make].filter(Boolean).join(' ') || 'Unknown Vehicle';
            var d = new Date(entry.date);
            var dateStr = (d.getMonth() + 1) + '/' + d.getDate() + '/' + d.getFullYear() + ' ' + d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            var cals = entry.calibrations || [];
            var highCount = 0;
            var medCount = 0;
            for (var j = 0; j < cals.length; j++) {
                if (cals[j].priority === 'high') highCount++;
                else medCount++;
            }

            html += '<div class="history-item" onclick="viewHistoryItem(' + entry.id + ')">';
            html += '<div class="history-item-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>';
            html += '<div class="history-item-info">';
            html += '<h4>' + escapeHtml(vehicleStr) + '</h4>';
            html += '<span class="history-item-meta">' + escapeHtml(entry.fileName) + ' &middot; ' + dateStr + '</span>';
            html += '</div>';
            html += '<div class="history-item-stats">';
            if (cals.length === 0) {
                html += '<span class="history-stat history-stat-count">0 calibrations</span>';
            } else {
                if (highCount > 0) html += '<span class="history-stat history-stat-high">' + highCount + ' high</span>';
                if (medCount > 0) html += '<span class="history-stat history-stat-medium">' + medCount + ' med</span>';
            }
            html += '</div>';
            if (cals.length > 0) {
                html += '<button class="history-item-download" onclick="event.stopPropagation();downloadHistoryPDF(' + entry.id + ')" title="Download PDF"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>';
            }
            html += '</div>';
        }
        html += '</div>';
    }

    html += '<div style="text-align:center;padding-top:24px"><button class="btn-download-pdf" onclick="resetMapper()" style="font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;padding:12px 28px;border-radius:10px;border:none;display:inline-flex;align-items:center;gap:8px"><svg viewBox="0 0 24 24" style="width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload New Estimate</button></div>';

    historySection.innerHTML = html;
}

function viewHistoryItem(id) {
    var history = getHistory();
    var entry = null;
    for (var i = 0; i < history.length; i++) {
        if (history[i].id === id) { entry = history[i]; break; }
    }
    if (!entry) return;

    historySection.style.display = 'none';
    var results = {
        calibrations: entry.calibrations,
        vehicleInfo: entry.vehicleInfo,
        _fromHistory: true
    };
    displayResults(results, entry.fileName);
}

function clearHistory() {
    localStorage.removeItem(HISTORY_KEY);
    updateHistoryBadge();
    showHistory();
}

document.getElementById('mapper-history-btn').addEventListener('click', showHistory);

// --- PDF Report Generation ---
function generateReportPDF(reportData) {
    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF({ unit: 'mm', format: 'letter' });
    var W = doc.internal.pageSize.getWidth();
    var H = doc.internal.pageSize.getHeight();
    var margin = 20;
    var usable = W - margin * 2;
    var y = 0;

    var RED = [220, 38, 38];
    var DARK = [26, 26, 26];
    var GRAY = [107, 114, 128];
    var LIGHT_GRAY = [156, 163, 175];
    var AMBER = [245, 158, 11];
    var GREEN = [16, 185, 129];
    var BG_RED = [254, 242, 242];
    var BG_LIGHT = [249, 250, 251];

    var cals = reportData.calibrations || [];
    var v = reportData.vehicleInfo || {};
    var vehicleStr = [v.year, v.make].filter(Boolean).join(' ');
    var fileName = reportData.fileName || 'estimate.pdf';
    var reportDate = reportData.date ? new Date(reportData.date) : new Date();
    var dateStr = reportDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    var timeStr = reportDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

    function addFooter() {
        doc.setDrawColor(230, 230, 230);
        doc.line(margin, H - 16, W - margin, H - 16);
        doc.setFontSize(8);
        doc.setTextColor.apply(doc, LIGHT_GRAY);
        doc.text('Generated by TRAK Mapper  |  get-trak.com', margin, H - 10);
        doc.text(dateStr + ' at ' + timeStr, W - margin, H - 10, { align: 'right' });
    }

    function checkPage(needed) {
        if (y + needed > H - 24) {
            addFooter();
            doc.addPage();
            y = 20;
        }
    }

    // === Header band ===
    doc.setFillColor.apply(doc, RED);
    doc.rect(0, 0, W, 3, 'F');

    // === TRAK wordmark ===
    y = 22;
    doc.setFontSize(26);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor.apply(doc, RED);
    doc.text('TRAK', margin, y);
    doc.setFontSize(11);
    doc.setTextColor.apply(doc, GRAY);
    doc.text('Mapper', margin + doc.getTextWidth('TRAK ') + 2, y);

    // Report title right-aligned
    doc.setFontSize(10);
    doc.setTextColor.apply(doc, LIGHT_GRAY);
    doc.text('ADAS Calibration Report', W - margin, y, { align: 'right' });

    // Divider
    y += 6;
    doc.setDrawColor(240, 240, 240);
    doc.line(margin, y, W - margin, y);

    // === Vehicle info block ===
    y += 12;
    if (vehicleStr) {
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor.apply(doc, DARK);
        doc.text(vehicleStr, margin, y);
        y += 7;
    }
    if (v.vin) {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor.apply(doc, GRAY);
        doc.text('VIN: ' + v.vin, margin, y);
        y += 5;
    }
    doc.setFontSize(9);
    doc.setTextColor.apply(doc, LIGHT_GRAY);
    doc.text('Source: ' + fileName, margin, y);
    y += 4;
    doc.text('Date: ' + dateStr, margin, y);

    // === Summary badge ===
    y += 12;
    var summaryText = cals.length + ' calibration' + (cals.length !== 1 ? 's' : '') + ' identified';
    var highCount = 0, medCount = 0;
    for (var c = 0; c < cals.length; c++) {
        if (cals[c].priority === 'high') highCount++;
        else medCount++;
    }

    // Summary pill
    doc.setFillColor.apply(doc, BG_RED);
    var pillW = doc.getTextWidth(summaryText) * 1.1 + 14;
    doc.roundedRect(margin, y - 5, pillW, 9, 3, 3, 'F');
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor.apply(doc, RED);
    doc.text(summaryText, margin + 7, y + 1);

    // Priority breakdown next to pill
    var bx = margin + pillW + 8;
    if (highCount > 0) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor.apply(doc, RED);
        doc.text(highCount + ' High Priority', bx, y + 1);
        bx += doc.getTextWidth(highCount + ' High Priority') + 6;
    }
    if (medCount > 0) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor.apply(doc, AMBER);
        doc.text(medCount + ' Medium Priority', bx, y + 1);
    }

    y += 14;

    // === Calibration cards ===
    var priorityOrder = { high: 0, medium: 1, low: 2 };
    cals.sort(function(a, b) { return (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2); });

    for (var i = 0; i < cals.length; i++) {
        var cal = cals[i];

        // Estimate card height
        var descLines = doc.setFontSize(9).setFont('helvetica', 'normal').splitTextToSize(cal.description, usable - 14);
        var triggerLines = [];
        for (var t = 0; t < cal.matchedTriggers.length; t++) {
            triggerLines.push(cal.matchedTriggers[t]);
        }
        var triggerText = 'Matched: ' + triggerLines.join('  |  ');
        var triggerWrapped = doc.splitTextToSize(triggerText, usable - 14);
        var cardH = 10 + 7 + (descLines.length * 4) + 6 + (triggerWrapped.length * 3.5) + 8;

        checkPage(cardH + 4);

        // Card background
        doc.setFillColor.apply(doc, BG_LIGHT);
        doc.roundedRect(margin, y, usable, cardH, 3, 3, 'F');

        // Priority bar
        var barColor = cal.priority === 'high' ? RED : (cal.priority === 'medium' ? AMBER : GREEN);
        doc.setFillColor.apply(doc, barColor);
        doc.roundedRect(margin, y, 3, cardH, 1.5, 1.5, 'F');

        var cx = margin + 8;
        var cy = y + 7;

        // Calibration type label
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor.apply(doc, barColor);
        doc.text(cal.calibrationType.toUpperCase() + '  |  ' + cal.priority.toUpperCase() + ' PRIORITY', cx, cy);
        cy += 6;

        // Name
        doc.setFontSize(13);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor.apply(doc, DARK);
        doc.text(cal.name, cx, cy);
        cy += 7;

        // Description
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor.apply(doc, GRAY);
        doc.text(descLines, cx, cy);
        cy += descLines.length * 4 + 4;

        // Triggers
        doc.setDrawColor(230, 230, 230);
        doc.line(cx, cy - 2, margin + usable - 8, cy - 2);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor.apply(doc, LIGHT_GRAY);
        doc.text(triggerWrapped, cx, cy + 2);

        y += cardH + 5;
    }

    // === Disclaimer ===
    checkPage(20);
    y += 4;
    doc.setDrawColor(240, 240, 240);
    doc.line(margin, y, W - margin, y);
    y += 7;
    doc.setFontSize(8);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor.apply(doc, LIGHT_GRAY);
    var disclaimer = 'This report is generated based on keyword analysis of the uploaded estimate and may not capture all required calibrations. Always verify with OEM repair procedures and position statements.';
    var discLines = doc.splitTextToSize(disclaimer, usable);
    doc.text(discLines, margin, y);

    addFooter();

    // File name for download
    var safeName = (vehicleStr || 'Vehicle').replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_');
    doc.save('TRAK_Calibration_Report_' + safeName + '.pdf');
}

function downloadCurrentPDF() {
    if (window._currentReport) {
        generateReportPDF(window._currentReport);
    }
}

function downloadHistoryPDF(id) {
    var history = getHistory();
    for (var i = 0; i < history.length; i++) {
        if (history[i].id === id) {
            generateReportPDF({
                calibrations: history[i].calibrations,
                vehicleInfo: history[i].vehicleInfo,
                fileName: history[i].fileName,
                date: history[i].date
            });
            return;
        }
    }
}

// Update badge on load
updateHistoryBadge();

// ============================================================
// === TECHNICIAN HUB DASHBOARD ===
// ============================================================

var thActiveTab = 'technicians';
var thDocFilter = 'all';
var thPendingFile = null; // staged file for document upload
var thSopPendingFile = null; // staged file for SOP upload
var thConfirmCallback = null;

// === Toast ===
function showToast(msg) {
    var t = document.getElementById('th-toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 2500);
}

// === Confirm Dialog ===
function showConfirm(title, message, onConfirm) {
    document.getElementById('th-confirm-title').textContent = title;
    document.getElementById('th-confirm-message').textContent = message;
    thConfirmCallback = onConfirm;
    document.getElementById('th-confirm-overlay').classList.add('active');
}
document.getElementById('th-confirm-yes').addEventListener('click', function() {
    document.getElementById('th-confirm-overlay').classList.remove('active');
    if (thConfirmCallback) thConfirmCallback();
    thConfirmCallback = null;
});
document.getElementById('th-confirm-no').addEventListener('click', function() {
    document.getElementById('th-confirm-overlay').classList.remove('active');
    thConfirmCallback = null;
});

// === Tab Switching ===
var tabButtons = document.querySelectorAll('.techhub-tab');
for (var i = 0; i < tabButtons.length; i++) {
    tabButtons[i].addEventListener('click', function() {
        var tab = this.getAttribute('data-tab');
        thActiveTab = tab;
        for (var j = 0; j < tabButtons.length; j++) {
            tabButtons[j].classList.toggle('active', tabButtons[j].getAttribute('data-tab') === tab);
        }
        document.getElementById('panel-documents').classList.toggle('active', tab === 'documents');
        document.getElementById('panel-sops').classList.toggle('active', tab === 'sops');
        document.getElementById('panel-technicians').classList.toggle('active', tab === 'technicians');
        document.getElementById('panel-metrics').classList.toggle('active', tab === 'metrics');
        loadActiveTabData();
    });
}

function loadActiveTabData() {
    if (thActiveTab === 'documents') loadDocuments();
    else if (thActiveTab === 'sops') loadSops();
    else if (thActiveTab === 'technicians') loadTechnicians();
    else if (thActiveTab === 'metrics') loadMetrics();
}

// === HTML Escaping ===
function thEscape(text) {
    var d = document.createElement('div');
    d.textContent = text || '';
    return d.innerHTML;
}

function thFormatDate(timestamp) {
    if (!timestamp) return '';
    var d = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return (d.getMonth()+1) + '/' + d.getDate() + '/' + d.getFullYear();
}

var CATEGORY_LABELS = {
    'oem-statements': 'OEM Statements', 'training': 'Training', 'safety': 'Safety',
    'forms': 'Forms', 'other': 'Other', 'calibration': 'Calibration',
    'equipment': 'Equipment', 'customer': 'Customer', 'general': 'General'
};

// ============================================================
// === DOCUMENTS ===
// ============================================================

var docUploadZone = document.getElementById('th-doc-upload-zone');
var docFileInput = document.getElementById('th-doc-file-input');
var docUploadForm = document.getElementById('th-doc-upload-form');

docUploadZone.addEventListener('click', function() { docFileInput.click(); });
docUploadZone.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('dragover'); });
docUploadZone.addEventListener('dragleave', function() { this.classList.remove('dragover'); });
docUploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    if (e.dataTransfer.files[0]) stageDocFile(e.dataTransfer.files[0]);
});
docFileInput.addEventListener('change', function() {
    if (this.files[0]) stageDocFile(this.files[0]);
});

function stageDocFile(file) {
    if (file.size > 10 * 1024 * 1024) {
        showToast('File must be under 10 MB');
        return;
    }
    thPendingFile = file;
    document.getElementById('th-doc-form-filename-text').textContent = file.name + ' (' + (file.size / 1024).toFixed(0) + ' KB)';
    docUploadForm.style.display = 'block';
    docUploadZone.style.display = 'none';
}

document.getElementById('th-doc-cancel-btn').addEventListener('click', function() {
    thPendingFile = null;
    docUploadForm.style.display = 'none';
    docUploadZone.style.display = '';
    docFileInput.value = '';
});

document.getElementById('th-doc-upload-btn').addEventListener('click', function() {
    if (!thPendingFile || !thUser) return;
    var file = thPendingFile;
    var category = document.getElementById('th-doc-category').value;
    var description = document.getElementById('th-doc-description').value.trim();
    var btn = this;
    btn.disabled = true;
    btn.textContent = 'Uploading...';
    var progressBar = document.getElementById('th-doc-progress');
    var progressFill = document.getElementById('th-doc-progress-fill');
    progressBar.style.display = 'block';

    var path = 'techhub/documents/' + Date.now() + '_' + file.name;
    var uploadTask = storage.ref(path).put(file);

    uploadTask.on('state_changed', function(snap) {
        var pct = (snap.bytesTransferred / snap.totalBytes) * 100;
        progressFill.style.width = pct + '%';
    }, function(err) {
        showToast('Upload failed: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Upload';
        progressBar.style.display = 'none';
    }, function() {
        uploadTask.snapshot.ref.getDownloadURL().then(function(url) {
            return db.collection('documents').add({
                name: file.name,
                category: category,
                fileUrl: url,
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                storagePath: path,
                description: description,
                uploadedBy: thUser.email,
                uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }).then(function() {
            showToast('Document uploaded');
            thPendingFile = null;
            docUploadForm.style.display = 'none';
            docUploadZone.style.display = '';
            docFileInput.value = '';
            document.getElementById('th-doc-description').value = '';
            progressBar.style.display = 'none';
            progressFill.style.width = '0%';
            btn.disabled = false;
            btn.textContent = 'Upload';
            loadDocuments();
        }).catch(function(err) {
            showToast('Error saving: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'Upload';
            progressBar.style.display = 'none';
        });
    });
});

// Category filter
var filterChips = document.querySelectorAll('#th-doc-filter-bar .th-filter-chip');
for (var i = 0; i < filterChips.length; i++) {
    filterChips[i].addEventListener('click', function() {
        thDocFilter = this.getAttribute('data-filter');
        for (var j = 0; j < filterChips.length; j++) {
            filterChips[j].classList.toggle('active', filterChips[j].getAttribute('data-filter') === thDocFilter);
        }
        loadDocuments();
    });
}

function loadDocuments() {
    var listEl = document.getElementById('th-doc-list');
    listEl.innerHTML = '<div class="th-loading"><div class="th-spinner"></div><p style="font-size:13px;color:var(--gray);animation:none;max-width:none">Loading documents...</p></div>';
    var query = db.collection('documents').orderBy('uploadedAt', 'desc');
    if (thDocFilter !== 'all') query = query.where('category', '==', thDocFilter);
    query.get().then(function(snap) {
        if (snap.empty) {
            listEl.innerHTML = '<div class="th-empty"><h3>No documents yet</h3><p>Upload your first document to get started.</p></div>';
            return;
        }
        var html = '<div class="th-card-list">';
        snap.forEach(function(doc) {
            var d = doc.data();
            var ext = (d.fileName || '').split('.').pop().toUpperCase();
            html += '<div class="th-card">';
            html += '<div class="th-card-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>';
            html += '<div class="th-card-info">';
            html += '<h4>' + thEscape(d.name) + '</h4>';
            html += '<div class="th-card-meta">';
            html += '<span class="th-card-tag">' + thEscape(CATEGORY_LABELS[d.category] || d.category) + '</span>';
            html += '<span>' + thEscape(ext) + '</span>';
            html += '<span>' + thFormatDate(d.uploadedAt) + '</span>';
            html += '<span>' + thEscape(d.uploadedBy) + '</span>';
            html += '</div>';
            if (d.description) html += '<p style="font-size:12px;color:var(--gray);margin-top:4px;animation:none;max-width:none">' + thEscape(d.description) + '</p>';
            html += '</div>';
            var isPdf = (d.fileName || '').toLowerCase().endsWith('.pdf');
            var isImage = /\.(png|jpg|jpeg|gif|webp)$/i.test(d.fileName || '');
            html += '<div class="th-card-actions">';
            if (isPdf || isImage) {
                html += '<button class="th-icon-btn" onclick="previewDocument(\'' + d.fileUrl + '\',\'' + thEscape(d.name) + '\',' + (isPdf ? 'true' : 'false') + ')" title="Preview"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>';
            }
            html += '<button class="th-icon-btn" onclick="window.open(\'' + d.fileUrl + '\',\'_blank\')" title="Download"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>';
            html += '<button class="th-icon-btn th-icon-btn-danger" onclick="deleteDocument(\'' + doc.id + '\',\'' + thEscape(d.storagePath || '') + '\')" title="Delete"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>';
            html += '</div></div>';
        });
        html += '</div>';
        listEl.innerHTML = html;
    }).catch(function(err) {
        listEl.innerHTML = '<div class="th-empty"><h3>Error loading documents</h3><p>' + thEscape(err.message) + '</p></div>';
    });
}

function previewDocument(url, name, isPdf) {
    var overlay = document.getElementById('th-preview-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'th-preview-overlay';
        overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1200;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;backdrop-filter:blur(4px)';
        overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.style.display = 'none'; });
        document.body.appendChild(overlay);
    }
    var html = '<div style="background:white;border-radius:12px;width:100%;max-width:900px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden">';
    html += '<div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #f3f4f6">';
    html += '<h3 style="font-size:15px;font-weight:700;color:var(--dark);margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + thEscape(name) + '</h3>';
    html += '<div style="display:flex;gap:8px;flex-shrink:0">';
    html += '<a href="' + url + '" target="_blank" class="th-btn th-btn-secondary" style="font-size:13px;padding:6px 14px;text-decoration:none;display:inline-flex;align-items:center;gap:4px">Open in new tab</a>';
    html += '<button onclick="document.getElementById(\'th-preview-overlay\').style.display=\'none\'" class="th-btn th-btn-secondary" style="font-size:13px;padding:6px 14px">Close</button>';
    html += '</div></div>';
    if (isPdf) {
        html += '<iframe src="' + url + '" style="flex:1;border:none;min-height:500px" title="Preview"></iframe>';
    } else {
        html += '<div style="flex:1;overflow:auto;display:flex;align-items:center;justify-content:center;padding:20px;background:#f9fafb">';
        html += '<img src="' + url + '" style="max-width:100%;max-height:70vh;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.1)" alt="' + thEscape(name) + '">';
        html += '</div>';
    }
    html += '</div>';
    overlay.innerHTML = html;
    overlay.style.display = 'flex';
}

function deleteDocument(docId, storagePath) {
    showConfirm('Delete Document', 'This document will be permanently removed.', function() {
        db.collection('documents').doc(docId).delete().then(function() {
            if (storagePath) storage.ref(storagePath).delete().catch(function() {});
            showToast('Document deleted');
            loadDocuments();
        }).catch(function(err) { showToast('Error: ' + err.message); });
    });
}

// ============================================================
// === SOPs ===
// ============================================================

var sopForm = document.getElementById('th-sop-form');
var sopListView = document.getElementById('th-sop-list-view');
var sopDetail = document.getElementById('th-sop-detail');
var sopFileInput = document.getElementById('th-sop-file-input');

document.getElementById('th-sop-create-btn').addEventListener('click', function() {
    thSopPendingFile = null;
    document.getElementById('th-sop-file-group').style.display = 'none';
    document.getElementById('th-sop-form-title').textContent = 'Create SOP';
    document.getElementById('th-sop-title').value = '';
    document.getElementById('th-sop-category').value = 'calibration';
    document.getElementById('th-sop-description').value = '';
    sopListView.style.display = 'none';
    sopForm.style.display = 'block';
});

document.getElementById('th-sop-upload-btn').addEventListener('click', function() {
    sopFileInput.click();
});

sopFileInput.addEventListener('change', function() {
    if (!this.files[0]) return;
    var file = this.files[0];
    if (file.size > 10 * 1024 * 1024) { showToast('File must be under 10 MB'); return; }
    thSopPendingFile = file;
    document.getElementById('th-sop-file-name-text').textContent = file.name;
    document.getElementById('th-sop-file-group').style.display = 'block';
    document.getElementById('th-sop-form-title').textContent = 'Upload SOP PDF';
    document.getElementById('th-sop-title').value = file.name.replace(/\.pdf$/i, '');
    document.getElementById('th-sop-category').value = 'calibration';
    document.getElementById('th-sop-description').value = '';
    sopListView.style.display = 'none';
    sopForm.style.display = 'block';
});

document.getElementById('th-sop-cancel-btn').addEventListener('click', function() {
    sopForm.style.display = 'none';
    sopListView.style.display = '';
    thSopPendingFile = null;
    sopFileInput.value = '';
});

document.getElementById('th-sop-save-btn').addEventListener('click', function() {
    var title = document.getElementById('th-sop-title').value.trim();
    var category = document.getElementById('th-sop-category').value;
    var description = document.getElementById('th-sop-description').value.trim();
    if (!title) { showToast('Please enter a title'); return; }
    if (!description && !thSopPendingFile) { showToast('Please enter a description or attach a PDF'); return; }
    var btn = this;
    btn.disabled = true;
    btn.textContent = 'Saving...';
    var progressBar = document.getElementById('th-sop-progress');
    var progressFill = document.getElementById('th-sop-progress-fill');

    function saveSopDoc(fileUrl, fileName, storagePath) {
        db.collection('sops').add({
            title: title,
            description: description,
            category: category,
            fileUrl: fileUrl || '',
            fileName: fileName || '',
            storagePath: storagePath || '',
            createdBy: thUser.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(function() {
            showToast('SOP saved');
            sopForm.style.display = 'none';
            sopListView.style.display = '';
            thSopPendingFile = null;
            sopFileInput.value = '';
            progressBar.style.display = 'none';
            progressFill.style.width = '0%';
            btn.disabled = false;
            btn.textContent = 'Save SOP';
            loadSops();
        }).catch(function(err) {
            showToast('Error: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'Save SOP';
            progressBar.style.display = 'none';
        });
    }

    if (thSopPendingFile) {
        progressBar.style.display = 'block';
        var path = 'techhub/sops/' + Date.now() + '_' + thSopPendingFile.name;
        var uploadTask = storage.ref(path).put(thSopPendingFile);
        uploadTask.on('state_changed', function(snap) {
            progressFill.style.width = ((snap.bytesTransferred / snap.totalBytes) * 100) + '%';
        }, function(err) {
            showToast('Upload failed: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'Save SOP';
            progressBar.style.display = 'none';
        }, function() {
            uploadTask.snapshot.ref.getDownloadURL().then(function(url) {
                saveSopDoc(url, thSopPendingFile.name, path);
            });
        });
    } else {
        saveSopDoc('', '', '');
    }
});

function loadSops() {
    var listEl = document.getElementById('th-sop-list');
    listEl.innerHTML = '<div class="th-loading"><div class="th-spinner"></div><p style="font-size:13px;color:var(--gray);animation:none;max-width:none">Loading SOPs...</p></div>';
    db.collection('sops').orderBy('createdAt', 'desc').get().then(function(snap) {
        if (snap.empty) {
            listEl.innerHTML = '<div class="th-empty"><h3>No SOPs yet</h3><p>Create your first standard operating procedure.</p></div>';
            return;
        }
        var html = '<div class="th-card-list">';
        snap.forEach(function(doc) {
            var d = doc.data();
            html += '<div class="th-card" style="cursor:pointer" onclick="viewSop(\'' + doc.id + '\')">';
            html += '<div class="th-card-icon"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div>';
            html += '<div class="th-card-info">';
            html += '<h4>' + thEscape(d.title) + '</h4>';
            html += '<div class="th-card-meta">';
            html += '<span class="th-card-tag">' + thEscape(CATEGORY_LABELS[d.category] || d.category) + '</span>';
            if (d.fileName) html += '<span>PDF attached</span>';
            html += '<span>' + thFormatDate(d.createdAt) + '</span>';
            html += '<span>' + thEscape(d.createdBy) + '</span>';
            html += '</div>';
            if (d.description) {
                var desc = d.description.length > 120 ? d.description.substring(0, 120) + '...' : d.description;
                html += '<p style="font-size:12px;color:var(--gray);margin-top:4px;animation:none;max-width:none">' + thEscape(desc) + '</p>';
            }
            html += '</div>';
            html += '<div class="th-card-actions">';
            html += '<button class="th-icon-btn th-icon-btn-danger" onclick="event.stopPropagation();deleteSop(\'' + doc.id + '\',\'' + thEscape(d.storagePath || '') + '\')" title="Delete"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>';
            html += '</div></div>';
        });
        html += '</div>';
        listEl.innerHTML = html;
    }).catch(function(err) {
        listEl.innerHTML = '<div class="th-empty"><h3>Error loading SOPs</h3><p>' + thEscape(err.message) + '</p></div>';
    });
}

function viewSop(sopId) {
    sopListView.style.display = 'none';
    sopDetail.style.display = 'block';
    sopDetail.innerHTML = '<div class="th-loading"><div class="th-spinner"></div></div>';
    db.collection('sops').doc(sopId).get().then(function(doc) {
        if (!doc.exists) { sopDetail.innerHTML = '<p>SOP not found.</p>'; return; }
        var d = doc.data();
        var html = '<button class="th-back-link" onclick="closeSopDetail()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg> Back to SOPs</button>';
        html += '<div class="th-sop-detail-header">';
        html += '<h2>' + thEscape(d.title) + '</h2>';
        html += '<div class="th-card-meta" style="margin-bottom:8px">';
        html += '<span class="th-card-tag">' + thEscape(CATEGORY_LABELS[d.category] || d.category) + '</span>';
        html += '<span>Created ' + thFormatDate(d.createdAt) + '</span>';
        html += '<span>by ' + thEscape(d.createdBy) + '</span>';
        html += '</div>';
        if (d.fileUrl) {
            html += '<a href="' + d.fileUrl + '" target="_blank" class="th-btn th-btn-primary" style="display:inline-flex;align-items:center;gap:6px;text-decoration:none;font-size:13px;padding:8px 16px;margin-top:4px">';
            html += '<svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:white;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
            html += 'Download PDF</a>';
        }
        html += '</div>';
        if (d.description) {
            html += '<div class="th-sop-detail-body">' + thEscape(d.description) + '</div>';
        }
        if (d.fileUrl && (d.fileName || '').toLowerCase().endsWith('.pdf')) {
            html += '<div style="border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;margin-top:16px">';
            html += '<iframe src="' + d.fileUrl + '" style="width:100%;height:600px;border:none" title="PDF Preview"></iframe>';
            html += '</div>';
        }
        sopDetail.innerHTML = html;
    });
}

function closeSopDetail() {
    sopDetail.style.display = 'none';
    sopListView.style.display = '';
}

function deleteSop(sopId, storagePath) {
    showConfirm('Delete SOP', 'This SOP will be permanently removed.', function() {
        db.collection('sops').doc(sopId).delete().then(function() {
            if (storagePath) storage.ref(storagePath).delete().catch(function() {});
            showToast('SOP deleted');
            loadSops();
        }).catch(function(err) { showToast('Error: ' + err.message); });
    });
}

// ============================================================
// === TECHNICIAN MANAGEMENT ===
// ============================================================

var thTechFilter = 'all';
var thTerminateCallback = null;
var thChecklistTemplate = null; // cached template

// --- Checklist Template ---
function loadChecklistTemplate() {
    return db.collection('settings').doc('checklist-template').get().then(function(doc) {
        if (doc.exists && doc.data().items) {
            thChecklistTemplate = doc.data().items;
        } else {
            thChecklistTemplate = [];
        }
        return thChecklistTemplate;
    }).catch(function() {
        thChecklistTemplate = [];
        return thChecklistTemplate;
    });
}

// --- Filter Chips ---
var techFilterChips = document.querySelectorAll('#th-tech-filter-bar .th-filter-chip');
for (var fi = 0; fi < techFilterChips.length; fi++) {
    techFilterChips[fi].addEventListener('click', function() {
        thTechFilter = this.getAttribute('data-filter');
        for (var fj = 0; fj < techFilterChips.length; fj++) {
            techFilterChips[fj].classList.toggle('active', techFilterChips[fj].getAttribute('data-filter') === thTechFilter);
        }
        loadTechnicians();
    });
}

// --- Add Technician ---
document.getElementById('th-add-tech-btn').addEventListener('click', function() {
    document.getElementById('th-add-tech-form').style.display = 'block';
    this.style.display = 'none';
    document.getElementById('th-tech-name').focus();
});

document.getElementById('th-tech-cancel-btn').addEventListener('click', function() {
    document.getElementById('th-add-tech-form').style.display = 'none';
    document.getElementById('th-add-tech-btn').style.display = '';
    document.getElementById('th-tech-name').value = '';
    document.getElementById('th-tech-email').value = '';
    document.getElementById('th-tech-phone').value = '';
    document.getElementById('th-tech-position').value = '';
    document.getElementById('th-tech-interview-date').value = '';
    document.getElementById('th-tech-init-notes').value = '';
});

document.getElementById('th-tech-save-btn').addEventListener('click', function() {
    var name = document.getElementById('th-tech-name').value.trim();
    if (!name) { showToast('Please enter a name'); return; }
    var email = document.getElementById('th-tech-email').value.trim();
    var phone = document.getElementById('th-tech-phone').value.trim();
    var position = document.getElementById('th-tech-position').value.trim();
    var interviewDate = document.getElementById('th-tech-interview-date').value;
    var initNotes = document.getElementById('th-tech-init-notes').value.trim();
    var btn = this;
    btn.disabled = true;
    btn.textContent = 'Adding...';

    // Fetch template to build initial checklist
    var templatePromise = thChecklistTemplate !== null ? Promise.resolve(thChecklistTemplate) : loadChecklistTemplate();
    templatePromise.then(function(templateItems) {
        var checklist = [];
        for (var i = 0; i < templateItems.length; i++) {
            checklist.push({ label: templateItems[i], completed: false });
        }
        return db.collection('technicians').add({
            name: name,
            email: email,
            phone: phone,
            position: position,
            interviewDate: interviewDate,
            startDate: '',
            status: 'interview',
            terminationType: null,
            terminationReason: '',
            terminatedAt: null,
            regionalManager: 'Brandon',
            role: 'Technician',
            checklist: checklist,
            notes: initNotes,
            addedBy: thUser.email,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }).then(function() {
        showToast('Technician added');
        document.getElementById('th-add-tech-form').style.display = 'none';
        document.getElementById('th-add-tech-btn').style.display = '';
        document.getElementById('th-tech-name').value = '';
        document.getElementById('th-tech-email').value = '';
        document.getElementById('th-tech-phone').value = '';
        document.getElementById('th-tech-position').value = '';
        document.getElementById('th-tech-interview-date').value = '';
        document.getElementById('th-tech-init-notes').value = '';
        btn.disabled = false;
        btn.textContent = 'Add Technician';
        loadTechnicians();
    }).catch(function(err) {
        showToast('Error: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Add Technician';
    });
});

// --- Normalize legacy statuses ---
function normalizeTechStatus(status) {
    if (status === 'onboarding') return 'active';
    if (status === 'hired') return 'active';
    if (status === 'inactive') return 'terminated';
    return status || 'interview';
}
function techStatusLabel(status) {
    if (status === 'interview') return 'Interview';
    if (status === 'active') return 'Active';
    if (status === 'terminated') return 'Terminated';
    return status;
}
function techStatusClass(status) {
    return 'th-tech-status-' + status;
}

// --- Load Technicians ---
function loadTechnicians() {
    var statsEl = document.getElementById('th-tech-stats');
    var listEl = document.getElementById('th-tech-list');
    listEl.innerHTML = '<div class="th-loading"><div class="th-spinner"></div><p style="font-size:13px;color:var(--gray);animation:none;max-width:none">Loading technicians...</p></div>';

    db.collection('technicians').orderBy('addedAt', 'desc').get().then(function(snap) {
        var counts = { interview: 0, active: 0, terminated: 0 };
        var techs = [];
        snap.forEach(function(doc) {
            var d = doc.data();
            d._id = doc.id;
            d.status = normalizeTechStatus(d.status);
            // Normalize old map-based checklist to array
            if (d.checklist && !Array.isArray(d.checklist)) {
                var arr = [];
                var keys = Object.keys(d.checklist);
                for (var k = 0; k < keys.length; k++) {
                    arr.push({ label: keys[k].replace(/-/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); }), completed: !!d.checklist[keys[k]].completed });
                }
                d.checklist = arr;
            }
            if (!d.checklist) d.checklist = [];
            techs.push(d);
            if (counts.hasOwnProperty(d.status)) counts[d.status]++;
        });

        // Stats
        var total = techs.length;
        statsEl.innerHTML =
            '<div class="th-stat-card"><div class="th-stat-number">' + total + '</div><div class="th-stat-label">Total</div></div>' +
            '<div class="th-stat-card stat-interview"><div class="th-stat-number">' + counts.interview + '</div><div class="th-stat-label">Interview</div></div>' +
            '<div class="th-stat-card stat-active"><div class="th-stat-number">' + counts.active + '</div><div class="th-stat-label">Active</div></div>';

        // Filter
        var filtered = [];
        for (var fi = 0; fi < techs.length; fi++) {
            if (thTechFilter === 'all' || techs[fi].status === thTechFilter) filtered.push(techs[fi]);
        }

        if (filtered.length === 0) {
            var msg = techs.length === 0 ? 'Add your first technician to get started.' : 'No technicians match this filter.';
            listEl.innerHTML = '<div class="th-empty"><h3>No technicians</h3><p>' + msg + '</p></div>';
            return;
        }

        var html = '';
        for (var i = 0; i < filtered.length; i++) {
            var t = filtered[i];
            var checklist = t.checklist;
            var done = 0;
            for (var ci = 0; ci < checklist.length; ci++) {
                if (checklist[ci].completed) done++;
            }
            var initials = t.name.split(' ').map(function(w) { return w[0]; }).join('').substring(0, 2).toUpperCase();
            var sClass = techStatusClass(t.status);
            var sLabel = techStatusLabel(t.status);

            html += '<div class="th-tech-card" id="tech-card-' + t._id + '">';
            html += '<div class="th-tech-summary" onclick="toggleTechCard(\'' + t._id + '\')">';
            html += '<div class="th-tech-avatar">' + thEscape(initials) + '</div>';
            html += '<div class="th-tech-info">';
            html += '<h4>' + thEscape(t.name) + '</h4>';
            if (t.position) html += '<div class="th-tech-position">' + thEscape(t.position) + '</div>';
            html += '</div>';
            html += '<span class="th-tech-status ' + sClass + '">' + sLabel + '</span>';
            html += '<svg class="th-tech-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>';
            html += '</div>';

            // Expanded detail
            html += '<div class="th-tech-detail">';

            // Contact info
            if (t.email || t.phone || t.interviewDate || t.startDate) {
                html += '<div style="font-size:13px;color:var(--gray);padding-top:12px;display:flex;gap:16px;flex-wrap:wrap">';
                if (t.email) html += '<span>' + thEscape(t.email) + '</span>';
                if (t.phone) html += '<span>' + thEscape(t.phone) + '</span>';
                if (t.interviewDate) html += '<span>Interview: ' + thEscape(t.interviewDate) + '</span>';
                if (t.startDate) html += '<span>Started: ' + thEscape(t.startDate) + '</span>';
                html += '</div>';
            }

            // Status dropdown + Start Date
            html += '<div style="margin-top:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">';
            html += '<label style="font-size:13px;font-weight:600;color:var(--dark)">Status:</label>';
            html += '<select class="th-status-select" onchange="changeTechStatus(\'' + t._id + '\',this.value,this)">';
            var statuses = ['interview','active','terminated'];
            var statusLabels = ['Interview','Active','Terminated'];
            for (var si = 0; si < statuses.length; si++) {
                html += '<option value="' + statuses[si] + '"' + (t.status === statuses[si] ? ' selected' : '') + '>' + statusLabels[si] + '</option>';
            }
            html += '</select>';
            // Start Date field
            html += '<label style="font-size:13px;font-weight:600;color:var(--dark);margin-left:12px">Start Date:</label>';
            html += '<input type="date" class="th-status-select" value="' + thEscape(t.startDate || '') + '" onchange="saveTechStartDate(\'' + t._id + '\',this.value)" style="min-width:140px">';
            html += '</div>';

            // Regional Manager dropdown
            html += '<div class="th-assignment-row">';
            html += '<label>Regional Manager:</label>';
            html += '<select class="th-status-select" onchange="saveTechField(\'' + t._id + '\',\'regionalManager\',this.value)">';
            if (!t.regionalManager) html += '<option value="" selected disabled>Select...</option>';
            var rmOptions = ['Brandon','Scott','Tyler','Aaron'];
            for (var ri = 0; ri < rmOptions.length; ri++) {
                html += '<option' + (t.regionalManager === rmOptions[ri] ? ' selected' : '') + '>' + rmOptions[ri] + '</option>';
            }
            html += '</select></div>';

            // Role dropdown
            html += '<div class="th-assignment-row">';
            html += '<label>Role:</label>';
            html += '<select class="th-status-select" onchange="saveTechField(\'' + t._id + '\',\'role\',this.value)">';
            var roleOptions = ['Technician','Pod Leader'];
            for (var roi = 0; roi < roleOptions.length; roi++) {
                html += '<option' + ((t.role || 'Technician') === roleOptions[roi] ? ' selected' : '') + '>' + roleOptions[roi] + '</option>';
            }
            html += '</select></div>';

            // Termination info
            if (t.status === 'terminated') {
                html += '<div class="th-termination-info">';
                html += '<strong>' + (t.terminationType === 'fired' ? 'Fired' : 'Quit') + '</strong>';
                if (t.terminationReason) html += ' &mdash; ' + thEscape(t.terminationReason);
                if (t.terminatedAt) html += '<br><small>' + thFormatDate(t.terminatedAt) + '</small>';
                html += '</div>';
            }

            // Checklist section
            var onboardPct = checklist.length > 0 ? Math.round((done / checklist.length) * 100) : 0;
            var onboardClass = onboardPct === 100 ? 'complete' : (onboardPct > 0 ? 'partial' : 'none');
            html += '<div style="margin-top:16px;border-top:1px solid #f3f4f6;padding-top:16px">';
            html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">';
            html += '<label style="font-size:13px;font-weight:700;color:var(--dark);margin-bottom:0">Checklist (' + done + '/' + checklist.length + ')</label>';
            if (t.status !== 'terminated') {
                html += '<span class="th-onboarding-badge ' + onboardClass + '">' + onboardPct + '% onboarded</span>';
            }
            html += '</div>';
            html += '<ul class="th-checklist">';
            for (var ci = 0; ci < checklist.length; ci++) {
                var item = checklist[ci];
                html += '<li class="th-checklist-item' + (item.completed ? ' done' : '') + '">';
                html += '<div class="th-checkbox' + (item.completed ? ' checked' : '') + '" onclick="toggleChecklistItem(\'' + t._id + '\',' + ci + ')">' + (item.completed ? '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>' : '') + '</div>';
                html += '<span class="th-checklist-label" onclick="toggleChecklistItem(\'' + t._id + '\',' + ci + ')">' + thEscape(item.label) + '</span>';
                html += '<button class="th-checklist-remove" onclick="removeChecklistItem(\'' + t._id + '\',' + ci + ')" title="Remove item">&times;</button>';
                html += '</li>';
            }
            html += '</ul>';
            html += '<div class="th-checklist-add">';
            html += '<input type="text" id="checklist-add-' + t._id + '" placeholder="Add checklist item...">';
            html += '<button onclick="addChecklistItem(\'' + t._id + '\')">Add</button>';
            html += '</div>';
            html += '</div>';

            // Per-tech documents
            html += '<div class="th-tech-docs">';
            html += '<div class="th-tech-docs-header">';
            html += '<h5>Documents</h5>';
            html += '<button class="th-btn th-btn-secondary" onclick="triggerTechDocUpload(\'' + t._id + '\')" style="font-size:12px;padding:4px 10px">Upload</button>';
            html += '</div>';
            html += '<input type="file" id="tech-doc-input-' + t._id + '" style="display:none" onchange="handleTechDocFile(\'' + t._id + '\',this)">';
            html += '<div id="tech-doc-progress-' + t._id + '"></div>';
            html += '<div class="th-tech-doc-list" id="tech-docs-' + t._id + '"><div style="font-size:12px;color:#9ca3af">Loading documents...</div></div>';
            html += '</div>';

            // Notes
            html += '<div class="th-tech-notes">';
            html += '<label>Notes</label>';
            html += '<textarea id="notes-' + t._id + '" placeholder="Add notes...">' + thEscape(t.notes || '') + '</textarea>';
            html += '</div>';
            html += '<div class="th-tech-actions">';
            html += '<button class="th-btn th-btn-secondary" onclick="saveNotes(\'' + t._id + '\')" style="font-size:13px;padding:6px 14px">Save Notes</button>';
            html += '<button class="th-btn th-btn-secondary th-icon-btn-danger" onclick="deleteTechnician(\'' + t._id + '\')" style="font-size:13px;padding:6px 14px;color:#ef4444;border-color:#fca5a5">Remove</button>';
            html += '</div>';
            html += '</div></div>';
        }
        listEl.innerHTML = html;

        // Load docs for each visible tech
        for (var di = 0; di < filtered.length; di++) {
            loadTechDocuments(filtered[di]._id);
        }
    }).catch(function(err) {
        listEl.innerHTML = '<div class="th-empty"><h3>Error loading technicians</h3><p>' + thEscape(err.message) + '</p></div>';
    });
}

// --- Load Metrics ---
function loadMetrics() {
    var container = document.getElementById('metrics-content');
    container.innerHTML = '<div class="th-loading"><div class="th-spinner"></div><p style="font-size:13px;color:var(--gray);animation:none;max-width:none">Loading metrics...</p></div>';

    db.collection('technicians').get().then(function(snap) {
        var techs = [];
        snap.forEach(function(doc) {
            var d = doc.data();
            d._id = doc.id;
            d.status = normalizeTechStatus(d.status);
            // Normalize checklist
            if (d.checklist && !Array.isArray(d.checklist)) {
                var arr = [];
                var keys = Object.keys(d.checklist);
                for (var k = 0; k < keys.length; k++) {
                    arr.push({ label: keys[k], completed: !!d.checklist[keys[k]].completed });
                }
                d.checklist = arr;
            }
            if (!d.checklist) d.checklist = [];
            techs.push(d);
        });

        var now = new Date();
        var rmNames = ['Brandon', 'Scott', 'Tyler', 'Aaron'];
        var html = '';

        // --- Section A: Headcount by Function ---
        var techCount = 0;
        var podLeaderCount = 0;
        for (var i = 0; i < techs.length; i++) {
            if (techs[i].status !== 'terminated') {
                if (techs[i].role === 'Pod Leader') podLeaderCount++;
                else techCount++;
            }
        }
        var rmCount = 4;
        var totalHeadcount = techCount + podLeaderCount + rmCount;

        html += '<div class="metrics-section">';
        html += '<div class="metrics-section-title">Headcount by Function</div>';
        html += '<div class="metrics-cards">';
        html += '<div class="metrics-card"><div class="metrics-card-number" style="color:#2563eb">' + techCount + '</div><div class="metrics-card-label">Technicians</div></div>';
        html += '<div class="metrics-card"><div class="metrics-card-number" style="color:#7c3aed">' + podLeaderCount + '</div><div class="metrics-card-label">Pod Leaders</div></div>';
        html += '<div class="metrics-card"><div class="metrics-card-number" style="color:#059669">' + rmCount + '</div><div class="metrics-card-label">Regional Managers</div></div>';
        html += '</div>';
        html += '<div class="metrics-total">Total Headcount: ' + totalHeadcount + '</div>';
        html += '</div>';

        // --- Section B: Retention Rates ---
        html += '<div class="metrics-section">';
        html += '<div class="metrics-section-title">Retention Rates by Regional Manager</div>';

        // Check if any techs have date data
        var hasAnyTechs = false;
        for (var ri = 0; ri < techs.length; ri++) {
            if (techs[ri].startDate || techs[ri].addedAt) { hasAnyTechs = true; break; }
        }

        if (!hasAnyTechs && techs.length === 0) {
            html += '<div class="th-empty" style="padding:24px 0"><p style="color:var(--gray);font-size:13px">No technician data yet</p></div>';
        } else {
            html += '<div class="metrics-tables-row">';

            // 90-day and 1-year retention tables
            var periods = [{ days: 90, label: '90-Day Retention' }, { days: 365, label: '1-Year Retention' }];
            for (var pi = 0; pi < periods.length; pi++) {
                var period = periods[pi];
                html += '<div class="metrics-table-wrapper">';
                html += '<div class="metrics-table-title">' + period.label + '</div>';
                html += '<table class="metrics-table"><thead><tr><th>Regional Manager</th><th>Rate</th></tr></thead><tbody>';

                // Per-RM rows
                for (var rmi = 0; rmi < rmNames.length; rmi++) {
                    var rm = rmNames[rmi];
                    var eligible = 0;
                    var retained = 0;
                    for (var ti = 0; ti < techs.length; ti++) {
                        var t = techs[ti];
                        if ((t.regionalManager || '') !== rm) continue;
                        var startDate = t.startDate ? new Date(t.startDate) : (t.addedAt ? (t.addedAt.toDate ? t.addedAt.toDate() : new Date(t.addedAt)) : null);
                        if (!startDate) continue;
                        var daysSinceAdded = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                        if (daysSinceAdded >= period.days) {
                            eligible++;
                            if (t.status !== 'terminated') retained++;
                        }
                    }
                    var rateStr, rateClass;
                    if (eligible === 0) {
                        rateStr = 'N/A';
                        rateClass = '';
                    } else {
                        var pct = Math.round((retained / eligible) * 100);
                        rateStr = pct + '%';
                        rateClass = pct >= 90 ? 'rate-good' : (pct >= 80 ? 'rate-mid' : 'rate-low');
                    }
                    html += '<tr><td>' + thEscape(rm) + '</td><td class="' + rateClass + '">' + rateStr + '</td></tr>';
                }

                // Company-wide row
                var compEligible = 0;
                var compRetained = 0;
                for (var ci = 0; ci < techs.length; ci++) {
                    var ct = techs[ci];
                    var ctStart = ct.startDate ? new Date(ct.startDate) : (ct.addedAt ? (ct.addedAt.toDate ? ct.addedAt.toDate() : new Date(ct.addedAt)) : null);
                    if (!ctStart) continue;
                    var ctDays = Math.floor((now - ctStart) / (1000 * 60 * 60 * 24));
                    if (ctDays >= period.days) {
                        compEligible++;
                        if (ct.status !== 'terminated') compRetained++;
                    }
                }
                var compStr, compClass;
                if (compEligible === 0) {
                    compStr = 'N/A';
                    compClass = '';
                } else {
                    var compPct = Math.round((compRetained / compEligible) * 100);
                    compStr = compPct + '%';
                    compClass = compPct >= 90 ? 'rate-good' : (compPct >= 80 ? 'rate-mid' : 'rate-low');
                }
                html += '<tr style="border-top:2px solid #e5e7eb"><td style="font-weight:700">Company</td><td class="' + compClass + '" style="font-weight:700">' + compStr + '</td></tr>';
                html += '</tbody></table></div>';
            }

            html += '</div>'; // metrics-tables-row
        }
        html += '</div>'; // metrics-section

        // --- Section C: Attrition Rates (Last 12 Months) ---
        var twelveMonthsAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
        var recentTerms = [];
        for (var ai = 0; ai < techs.length; ai++) {
            var at = techs[ai];
            if (at.status !== 'terminated') continue;
            var termDate = at.terminatedAt ? (at.terminatedAt.toDate ? at.terminatedAt.toDate() : new Date(at.terminatedAt)) : null;
            if (termDate && termDate >= twelveMonthsAgo) {
                recentTerms.push(at);
            }
        }

        var quitCount = 0;
        var firedCount = 0;
        for (var qi = 0; qi < recentTerms.length; qi++) {
            if (recentTerms[qi].terminationType === 'fired') firedCount++;
            else quitCount++;
        }
        var totalTerms = quitCount + firedCount;
        var quitPct = totalTerms > 0 ? Math.round((quitCount / totalTerms) * 100) : 0;
        var firedPct = totalTerms > 0 ? Math.round((firedCount / totalTerms) * 100) : 0;

        html += '<div class="metrics-section">';
        html += '<div class="metrics-section-title">Attrition Rates (Last 12 Months)</div>';
        html += '<div class="attrition-cards">';
        html += '<div class="attrition-card attrition-quit"><div class="attrition-card-number">' + quitPct + '%</div><div class="attrition-card-label">Voluntary (Quit)</div></div>';
        html += '<div class="attrition-card attrition-fired"><div class="attrition-card-number">' + firedPct + '%</div><div class="attrition-card-label">Involuntary (Fired)</div></div>';
        html += '</div>';

        html += '<div class="metrics-table-wrapper">';
        html += '<div class="metrics-table-title">Attrition Breakdown</div>';
        html += '<table class="metrics-table"><thead><tr><th>Technician</th><th>Type</th><th>Reason</th><th>Regional Manager</th></tr></thead><tbody>';
        if (recentTerms.length === 0) {
            html += '<tr><td colspan="4" style="text-align:center;color:var(--gray);padding:20px">No terminations in the last 12 months</td></tr>';
        } else {
            for (var bi = 0; bi < recentTerms.length; bi++) {
                var bt = recentTerms[bi];
                var typeBadge = bt.terminationType === 'fired'
                    ? '<span class="badge-fired">Fired</span>'
                    : '<span class="badge-quit">Quit</span>';
                html += '<tr><td>' + thEscape(bt.name || '') + '</td><td>' + typeBadge + '</td><td>' + thEscape(bt.terminationReason || '') + '</td><td>' + thEscape(bt.regionalManager || '') + '</td></tr>';
            }
        }
        html += '</tbody></table></div>';
        html += '</div>';

        // --- Section D: Onboarding Completion ---
        var activeTechs = [];
        for (var oi = 0; oi < techs.length; oi++) {
            if (techs[oi].status !== 'terminated') activeTechs.push(techs[oi]);
        }

        html += '<div class="metrics-section">';
        html += '<div class="metrics-section-title">Onboarding Completion</div>';
        html += '<div class="metrics-table-wrapper">';

        if (activeTechs.length === 0) {
            html += '<div class="th-empty" style="padding:24px"><p style="color:var(--gray);font-size:13px">No technicians to display</p></div>';
        } else {
            html += '<table class="metrics-table"><thead><tr><th>Technician</th><th>Regional Manager</th><th>Checklist</th><th>Onboarded</th></tr></thead><tbody>';
            for (var di = 0; di < activeTechs.length; di++) {
                var dt = activeTechs[di];
                var checklist = dt.checklist;
                var done = 0;
                for (var dci = 0; dci < checklist.length; dci++) {
                    if (checklist[dci].completed) done++;
                }
                var total = checklist.length;
                var pctVal = total > 0 ? Math.round((done / total) * 100) : 0;
                var barColor, textColor;
                if (pctVal === 100) {
                    barColor = '#10b981';
                    textColor = '#10b981';
                } else if (pctVal > 0) {
                    barColor = '#d97706';
                    textColor = '#d97706';
                } else {
                    barColor = '#d1d5db';
                    textColor = 'var(--gray)';
                }
                html += '<tr><td>' + thEscape(dt.name || '') + '</td><td>' + thEscape(dt.regionalManager || '') + '</td><td>' + done + '/' + total + '</td>';
                html += '<td><div class="onboarding-bar"><div class="onboarding-bar-fill" style="width:' + pctVal + '%;background:' + barColor + '"></div></div><span style="font-weight:600;color:' + textColor + '">' + pctVal + '%</span></td></tr>';
            }
            html += '</tbody></table>';
        }

        html += '</div>';
        html += '</div>';

        container.innerHTML = html;
    }).catch(function(err) {
        container.innerHTML = '<div class="th-empty"><h3>Error loading metrics</h3><p>' + thEscape(err.message) + '</p></div>';
    });
}

function toggleTechCard(id) {
    var card = document.getElementById('tech-card-' + id);
    if (card) card.classList.toggle('expanded');
}

// --- Status Change ---
function changeTechStatus(techId, newStatus, selectEl) {
    if (newStatus === 'terminated') {
        openTerminateDialog(techId, selectEl);
        return;
    }
    db.collection('technicians').doc(techId).update({
        status: newStatus,
        terminationType: null,
        terminationReason: '',
        terminatedAt: null
    }).then(function() {
        showToast('Status updated');
        loadTechnicians();
    }).catch(function(err) {
        showToast('Error: ' + err.message);
    });
}

// --- Start Date ---
function saveTechStartDate(techId, value) {
    db.collection('technicians').doc(techId).update({
        startDate: value
    }).then(function() {
        showToast('Start date saved');
    }).catch(function(err) {
        showToast('Error: ' + err.message);
    });
}

// --- Save generic field (Regional Manager, Role) ---
function saveTechField(techId, field, value) {
    var update = {};
    update[field] = value;
    db.collection('technicians').doc(techId).update(update).then(function() {
        showToast(field === 'regionalManager' ? 'Regional Manager updated' : 'Role updated');
    }).catch(function(err) {
        showToast('Error: ' + err.message);
    });
}

// --- Termination Flow ---
function openTerminateDialog(techId, selectEl) {
    var overlay = document.getElementById('th-terminate-overlay');
    overlay.classList.add('active');
    document.getElementById('th-terminate-reason').value = '';
    // Reset type buttons to Quit
    var typeBtns = overlay.querySelectorAll('.th-terminate-type-btn');
    for (var i = 0; i < typeBtns.length; i++) {
        typeBtns[i].classList.toggle('active', typeBtns[i].getAttribute('data-type') === 'quit');
    }
    thTerminateCallback = function(type, reason) {
        db.collection('technicians').doc(techId).update({
            status: 'terminated',
            terminationType: type,
            terminationReason: reason,
            terminatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(function() {
            showToast('Technician terminated');
            loadTechnicians();
        }).catch(function(err) {
            showToast('Error: ' + err.message);
        });
    };
    // If cancelled, revert the dropdown
    overlay._revertSelect = selectEl;
    overlay._revertTechId = techId;
}

// Termination type toggle buttons
var termTypeBtns = document.querySelectorAll('.th-terminate-type-btn');
for (var ti = 0; ti < termTypeBtns.length; ti++) {
    termTypeBtns[ti].addEventListener('click', function() {
        for (var tj = 0; tj < termTypeBtns.length; tj++) {
            termTypeBtns[tj].classList.remove('active');
        }
        this.classList.add('active');
    });
}

document.getElementById('th-terminate-confirm').addEventListener('click', function() {
    var overlay = document.getElementById('th-terminate-overlay');
    var activeBtn = overlay.querySelector('.th-terminate-type-btn.active');
    var type = activeBtn ? activeBtn.getAttribute('data-type') : 'quit';
    var reason = document.getElementById('th-terminate-reason').value.trim();
    overlay.classList.remove('active');
    if (thTerminateCallback) thTerminateCallback(type, reason);
    thTerminateCallback = null;
});

document.getElementById('th-terminate-cancel').addEventListener('click', function() {
    var overlay = document.getElementById('th-terminate-overlay');
    overlay.classList.remove('active');
    thTerminateCallback = null;
    // Revert select to previous value
    if (overlay._revertTechId) {
        db.collection('technicians').doc(overlay._revertTechId).get().then(function(doc) {
            if (doc.exists) {
                var sel = overlay._revertSelect;
                if (sel) sel.value = normalizeTechStatus(doc.data().status);
            }
        });
    }
});

// --- Checklist Item Toggle ---
function toggleChecklistItem(techId, index) {
    db.collection('technicians').doc(techId).get().then(function(doc) {
        var d = doc.data();
        var checklist = d.checklist || [];
        if (!Array.isArray(checklist) || index >= checklist.length) return;
        checklist[index].completed = !checklist[index].completed;
        return db.collection('technicians').doc(techId).update({ checklist: checklist });
    }).then(function() {
        loadTechnicians();
    }).catch(function(err) {
        showToast('Error: ' + err.message);
    });
}

// --- Add Checklist Item ---
function addChecklistItem(techId) {
    var input = document.getElementById('checklist-add-' + techId);
    if (!input) return;
    var label = input.value.trim();
    if (!label) { showToast('Please enter an item name'); return; }
    db.collection('technicians').doc(techId).get().then(function(doc) {
        var d = doc.data();
        var checklist = d.checklist || [];
        if (!Array.isArray(checklist)) checklist = [];
        checklist.push({ label: label, completed: false });
        return db.collection('technicians').doc(techId).update({ checklist: checklist });
    }).then(function() {
        showToast('Item added');
        loadTechnicians();
    }).catch(function(err) {
        showToast('Error: ' + err.message);
    });
}

// --- Remove Checklist Item ---
function removeChecklistItem(techId, index) {
    showConfirm('Remove Checklist Item', 'This item will be removed from this technician\'s checklist.', function() {
        db.collection('technicians').doc(techId).get().then(function(doc) {
            var d = doc.data();
            var checklist = d.checklist || [];
            if (!Array.isArray(checklist) || index >= checklist.length) return;
            checklist.splice(index, 1);
            return db.collection('technicians').doc(techId).update({ checklist: checklist });
        }).then(function() {
            showToast('Item removed');
            loadTechnicians();
        }).catch(function(err) {
            showToast('Error: ' + err.message);
        });
    });
}

// --- Per-Tech Document Upload ---
function triggerTechDocUpload(techId) {
    var input = document.getElementById('tech-doc-input-' + techId);
    if (input) input.click();
}

function handleTechDocFile(techId, input) {
    var file = input.files[0];
    if (!file) return;
    var progressEl = document.getElementById('tech-doc-progress-' + techId);
    progressEl.innerHTML = '<div class="th-tech-doc-progress"><div style="width:0%"></div></div>';
    var timestamp = Date.now();
    var storagePath = 'techhub/technicians/' + techId + '/' + timestamp + '_' + file.name;
    var ref = firebase.storage().ref(storagePath);
    var task = ref.put(file);
    task.on('state_changed', function(snapshot) {
        var pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
        var bar = progressEl.querySelector('div div');
        if (bar) bar.style.width = pct + '%';
    }, function(err) {
        showToast('Upload error: ' + err.message);
        progressEl.innerHTML = '';
        input.value = '';
    }, function() {
        task.snapshot.ref.getDownloadURL().then(function(url) {
            return db.collection('technicians').doc(techId).collection('documents').add({
                name: file.name,
                fileUrl: url,
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                storagePath: storagePath,
                uploadedBy: thUser.email,
                uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }).then(function() {
            showToast('Document uploaded');
            progressEl.innerHTML = '';
            input.value = '';
            loadTechDocuments(techId);
        }).catch(function(err) {
            showToast('Error: ' + err.message);
            progressEl.innerHTML = '';
            input.value = '';
        });
    });
}

function loadTechDocuments(techId) {
    var listEl = document.getElementById('tech-docs-' + techId);
    if (!listEl) return;
    db.collection('technicians').doc(techId).collection('documents').orderBy('uploadedAt', 'desc').get().then(function(snap) {
        if (snap.empty) {
            listEl.innerHTML = '<div style="font-size:12px;color:#9ca3af;padding:4px 0">No documents uploaded yet.</div>';
            return;
        }
        var html = '';
        snap.forEach(function(doc) {
            var d = doc.data();
            var size = d.fileSize ? (d.fileSize < 1024 * 1024 ? Math.round(d.fileSize / 1024) + ' KB' : (d.fileSize / (1024 * 1024)).toFixed(1) + ' MB') : '';
            html += '<div class="th-tech-doc-item">';
            html += '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
            html += '<span title="' + thEscape(d.fileName) + '">' + thEscape(d.fileName) + '</span>';
            if (size) html += '<small>' + size + '</small>';
            html += '<a href="' + thEscape(d.fileUrl) + '" target="_blank" rel="noopener">View</a>';
            html += '<button onclick="deleteTechDocument(\'' + techId + '\',\'' + doc.id + '\',\'' + thEscape(d.storagePath) + '\')" title="Delete">&times;</button>';
            html += '</div>';
        });
        listEl.innerHTML = html;
    }).catch(function(err) {
        listEl.innerHTML = '<div style="font-size:12px;color:#ef4444">Error loading documents</div>';
    });
}

function deleteTechDocument(techId, docId, storagePath) {
    showConfirm('Delete Document', 'This document will be permanently deleted.', function() {
        var promises = [
            db.collection('technicians').doc(techId).collection('documents').doc(docId).delete()
        ];
        if (storagePath) {
            promises.push(firebase.storage().ref(storagePath).delete().catch(function() {}));
        }
        Promise.all(promises).then(function() {
            showToast('Document deleted');
            loadTechDocuments(techId);
        }).catch(function(err) {
            showToast('Error: ' + err.message);
        });
    });
}

// --- Notes ---
function saveNotes(techId) {
    var textarea = document.getElementById('notes-' + techId);
    if (!textarea) return;
    db.collection('technicians').doc(techId).update({
        notes: textarea.value
    }).then(function() {
        showToast('Notes saved');
    }).catch(function(err) {
        showToast('Error: ' + err.message);
    });
}

// --- Delete Technician (cascade) ---
function deleteTechnician(techId) {
    showConfirm('Remove Technician', 'This technician and all their data (documents, checklist) will be permanently removed.', function() {
        // First delete subcollection docs + storage files
        db.collection('technicians').doc(techId).collection('documents').get().then(function(snap) {
            var promises = [];
            snap.forEach(function(doc) {
                var d = doc.data();
                if (d.storagePath) {
                    promises.push(firebase.storage().ref(d.storagePath).delete().catch(function() {}));
                }
                promises.push(doc.ref.delete());
            });
            return Promise.all(promises);
        }).then(function() {
            return db.collection('technicians').doc(techId).delete();
        }).then(function() {
            showToast('Technician removed');
            loadTechnicians();
        }).catch(function(err) { showToast('Error: ' + err.message); });
    });
}

// --- Checklist Template Editor ---
document.getElementById('th-manage-checklist-btn').addEventListener('click', function() {
    openTemplateEditor();
});

function openTemplateEditor() {
    var overlay = document.getElementById('th-template-overlay');
    overlay.classList.add('active');
    var templatePromise = thChecklistTemplate !== null ? Promise.resolve(thChecklistTemplate) : loadChecklistTemplate();
    templatePromise.then(function(items) {
        renderTemplateItems(items);
    });
}

function renderTemplateItems(items) {
    var container = document.getElementById('th-template-items');
    if (!items || items.length === 0) {
        container.innerHTML = '<div style="font-size:13px;color:#9ca3af;padding:8px 0">No template items yet. Add items below.</div>';
        return;
    }
    var html = '';
    for (var i = 0; i < items.length; i++) {
        html += '<div class="th-template-item" data-index="' + i + '">';
        html += '<span>' + thEscape(items[i]) + '</span>';
        html += '<button onclick="removeTemplateItem(' + i + ')" title="Remove">&times;</button>';
        html += '</div>';
    }
    container.innerHTML = html;
}

function removeTemplateItem(index) {
    if (!thChecklistTemplate) return;
    thChecklistTemplate.splice(index, 1);
    renderTemplateItems(thChecklistTemplate);
}

document.getElementById('th-template-add-btn').addEventListener('click', function() {
    var input = document.getElementById('th-template-new-item');
    var val = input.value.trim();
    if (!val) return;
    if (!thChecklistTemplate) thChecklistTemplate = [];
    thChecklistTemplate.push(val);
    input.value = '';
    renderTemplateItems(thChecklistTemplate);
});

document.getElementById('th-template-new-item').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('th-template-add-btn').click();
    }
});

document.getElementById('th-template-save-btn').addEventListener('click', function() {
    saveChecklistTemplate();
});

function saveChecklistTemplate() {
    var items = thChecklistTemplate || [];
    db.collection('settings').doc('checklist-template').set({ items: items }).then(function() {
        showToast('Checklist template saved');
        document.getElementById('th-template-overlay').classList.remove('active');
    }).catch(function(err) {
        showToast('Error: ' + err.message);
    });
}

document.getElementById('th-template-close-btn').addEventListener('click', function() {
    document.getElementById('th-template-overlay').classList.remove('active');
    // Reload template in case user made changes but didn't save
    loadChecklistTemplate();
});

</script>

</body>
</html>
