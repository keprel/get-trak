<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAK - Never Miss an ADAS Calibration Again</title>
    <meta name="description" content="TRAK is the operating system for ADAS calibration businesses and collision centers. Scheduling, reporting, workflow, billing, analytics, and customer access in one platform.">
    <link rel="canonical" href="https://adastrak.com">
    <link rel="icon" type="image/jpeg" href="logo-icon.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --red: #DC2626;
            --red-light: #EF4444;
            --dark: #1a1a1a;
            --gray: #6b7280;
            --white: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--dark);
            background: var(--white);
            background-image: radial-gradient(ellipse at 50% 0%, #fef2f2 0%, var(--white) 70%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px 24px;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            text-align: center;
            max-width: 820px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .logo {
            height: 50px;
            margin-bottom: 28px;
            animation: fadeUp 0.6s ease-out both;
        }

        h1 {
            font-size: clamp(32px, 4.5vw, 46px);
            font-weight: 900;
            line-height: 1.08;
            letter-spacing: -1.5px;
            margin-bottom: 16px;
            animation: fadeUp 0.6s ease-out 0.1s both;
        }

        h1 span { color: var(--red); }

        p {
            font-size: 15px;
            color: var(--gray);
            line-height: 1.6;
            max-width: 540px;
            margin: 0 auto 28px;
            animation: fadeUp 0.6s ease-out 0.2s both;
        }

        .ctas {
            display: flex;
            justify-content: center;
            gap: 14px;
            flex-wrap: wrap;
            margin-bottom: 32px;
            animation: fadeUp 0.6s ease-out 0.3s both;
        }

        .btn {
            display: inline-block;
            padding: 12px 28px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 15px;
            text-decoration: none;
            transition: all 0.25s ease;
        }

        .btn-primary {
            background: var(--red);
            color: var(--white);
            box-shadow: 0 4px 14px rgba(220, 38, 38, 0.3);
        }

        .btn-primary:hover {
            background: var(--red-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        .btn-outline {
            background: var(--white);
            color: var(--dark);
            border: 1.5px solid #d1d5db;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .btn-outline:hover {
            border-color: var(--red);
            color: var(--red);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        .btn-outline:active {
            transform: translateY(0);
        }

        .features {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            max-width: 800px;
            margin: 0 auto 32px;
            text-align: left;
        }

        .feature-card {
            padding: 18px;
            border-radius: 12px;
            border: 1px solid #f3f4f6;
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.25s ease;
        }

        .feature-card:hover {
            border-color: #e5e7eb;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
        }

        .feature-icon {
            width: 32px;
            height: 32px;
            background: #fef2f2;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .feature-icon svg {
            width: 16px;
            height: 16px;
            stroke: var(--red);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .feature-card h3 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--dark);
        }

        .feature-card p {
            font-size: 12.5px;
            color: var(--gray);
            line-height: 1.45;
            margin: 0;
            max-width: none;
            animation: none;
        }

        .bottom-cta {
            text-align: center;
            margin-bottom: 56px;
        }

        .bottom-cta h2 {
            font-size: clamp(22px, 3vw, 28px);
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 12px;
        }

        .bottom-cta p {
            font-size: 15px;
            color: var(--gray);
            margin: 0 auto 24px;
            animation: none;
        }

        @media (max-width: 640px) {
            .features {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        .divider {
            width: 48px;
            height: 2px;
            background: #e5e7eb;
            margin: 0 auto 16px;
            animation: fadeUp 0.6s ease-out 0.4s both;
        }

        .footer-text {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 0;
            animation: fadeUp 0.6s ease-out 0.45s both;
        }

        .footer-text a {
            color: var(--red);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .footer-text a:hover { text-decoration: underline; }

        .footer-contact {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 4px;
            animation: fadeUp 0.6s ease-out 0.45s both;
        }

        .footer-contact a {
            color: #9ca3af;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-contact a:hover { color: var(--gray); text-decoration: underline; }

        .footer-links {
            font-size: 12px;
            color: #d1d5db;
            margin-bottom: 0;
            animation: fadeUp 0.6s ease-out 0.5s both;
        }

        .footer-links a {
            color: #9ca3af;
            text-decoration: none;
            font-weight: 400;
            transition: color 0.2s;
        }

        .footer-links a:hover { color: var(--gray); text-decoration: underline; }

        /* Decorative ADAS equipment illustrations */
        .deco {
            position: fixed;
            pointer-events: none;
            z-index: 0;
            opacity: 0;
            animation: decoFade 1s ease-out forwards;
        }

        .deco svg {
            stroke: #e5d0d0;
            fill: none;
            stroke-width: 1.2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        @keyframes decoFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .deco-tablet {
            top: 6%;
            left: 3%;
            width: 120px;
            transform: rotate(-12deg);
            animation-delay: 0.6s;
        }

        .deco-target {
            top: 4%;
            right: 3%;
            width: 110px;
            transform: rotate(8deg);
            animation-delay: 0.8s;
        }

        .deco-radar {
            bottom: 8%;
            left: 4%;
            width: 100px;
            transform: rotate(6deg);
            animation-delay: 1s;
        }

        .deco-stand {
            bottom: 6%;
            right: 3%;
            width: 90px;
            transform: rotate(-5deg);
            animation-delay: 1.2s;
        }

        @media (max-width: 1100px) {
            .deco { display: none; }
        }

        /* Password Modal */
        .password-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .password-overlay.active { opacity: 1; }
        .password-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .password-overlay.active .password-modal { transform: scale(1); }
        .password-modal h2 {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        .password-modal .modal-subtitle {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 24px;
            max-width: none;
            animation: none;
        }
        .password-modal input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #d1d5db;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 8px;
            text-align: center;
            letter-spacing: 2px;
        }
        .password-modal input:focus { border-color: var(--red); }
        .password-modal input.shake {
            animation: shake 0.4s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .password-error {
            color: var(--red);
            font-size: 13px;
            margin-bottom: 12px;
            display: none;
            max-width: none;
            animation: none;
        }
        .password-modal .modal-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--red);
            color: white;
            margin-bottom: 10px;
        }
        .password-modal .modal-btn:hover { background: var(--red-light); }
        .password-modal .modal-cancel {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            padding: 8px;
        }
        .password-modal .modal-cancel:hover { color: var(--dark); }

        /* Mapper Section */
        .mapper-section {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 900;
            overflow-y: auto;
            display: none;
            animation: fadeUp 0.4s ease-out;
        }
        .mapper-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 32px;
            border-bottom: 1px solid #f3f4f6;
        }
        .mapper-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .mapper-header img { height: 32px; }
        .mapper-header h1 {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin: 0;
            animation: none;
        }
        .mapper-back {
            background: none;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.2s;
        }
        .mapper-back:hover { border-color: var(--red); color: var(--red); }
        .mapper-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 48px 24px;
        }
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 16px;
            padding: 64px 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--red);
            background: #fef2f2;
        }
        .upload-zone-icon {
            width: 56px;
            height: 56px;
            background: #fef2f2;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        .upload-zone-icon svg {
            width: 28px;
            height: 28px;
            stroke: var(--red);
            fill: none;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .upload-zone h3 {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        .upload-zone p {
            font-size: 14px;
            color: var(--gray);
            margin: 0;
            animation: none;
            max-width: none;
        }
        .upload-zone .browse-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 24px;
            background: var(--red);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upload-zone .browse-btn:hover { background: var(--red-light); }

        /* Processing State */
        .processing-state {
            text-align: center;
            padding: 64px 32px;
            display: none;
        }
        .processing-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #f3f4f6;
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .processing-state p {
            font-size: 15px;
            color: var(--gray);
            animation: none;
            max-width: none;
        }

        /* Results */
        .results-section { display: none; }
        .results-header {
            text-align: center;
            margin-bottom: 32px;
        }
        .results-header h2 {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }
        .results-vehicle {
            font-size: 15px;
            color: var(--gray);
            margin-bottom: 4px;
            max-width: none;
            animation: none;
        }
        .results-file {
            font-size: 13px;
            color: #9ca3af;
            margin: 4px auto 16px;
            max-width: none;
            animation: none;
        }
        .results-summary {
            display: inline-block;
            padding: 6px 14px;
            background: #fef2f2;
            color: var(--red);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .results-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 32px;
        }
        .calibration-card {
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            padding: 20px 24px;
            background: white;
            transition: box-shadow 0.2s;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        .calibration-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        .cal-priority {
            width: 4px;
            border-radius: 2px;
            align-self: stretch;
            flex-shrink: 0;
        }
        .cal-priority-high { background: var(--red); }
        .cal-priority-medium { background: #f59e0b; }
        .cal-priority-low { background: #10b981; }
        .cal-info { flex: 1; }
        .cal-info h3 {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--dark);
        }
        .cal-type {
            font-size: 12px;
            font-weight: 600;
            color: var(--red);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .cal-info p {
            font-size: 13px;
            color: var(--gray);
            line-height: 1.5;
            margin: 0;
            animation: none;
            max-width: none;
        }
        .cal-triggers {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f3f4f6;
        }
        .cal-triggers span {
            display: inline-block;
            padding: 3px 10px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            color: var(--gray);
            margin-right: 6px;
            margin-bottom: 4px;
        }
        .no-calibrations {
            text-align: center;
            padding: 48px;
            color: var(--gray);
        }
        .no-calibrations h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        .no-calibrations p { max-width: none; animation: none; }
        .results-actions {
            padding-top: 16px;
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .results-actions button {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            border: 1.5px solid #d1d5db;
            background: white;
            color: var(--dark);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .results-actions button:hover { border-color: var(--red); color: var(--red); }
        .results-actions button svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .btn-download-pdf {
            background: var(--red) !important;
            color: white !important;
            border-color: var(--red) !important;
        }
        .btn-download-pdf:hover {
            background: var(--red-light) !important;
            border-color: var(--red-light) !important;
            color: white !important;
        }
        .history-item-download {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1.5px solid #e5e7eb;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .history-item-download:hover {
            border-color: var(--red);
            background: #fef2f2;
        }
        .history-item-download svg {
            width: 16px;
            height: 16px;
            stroke: var(--gray);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .history-item-download:hover svg { stroke: var(--red); }

        /* History */
        .mapper-header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .mapper-history-btn {
            background: none;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .mapper-history-btn:hover { border-color: var(--red); color: var(--red); }
        .mapper-history-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .history-badge {
            background: var(--red);
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }
        .history-section {
            display: none;
        }
        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        .history-header h2 {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        .history-clear-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .history-clear-btn:hover { color: var(--red); background: #fef2f2; }
        .history-list {
            display: grid;
            gap: 12px;
        }
        .history-item {
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            padding: 16px 20px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .history-item:hover {
            border-color: #e5e7eb;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        .history-item-icon {
            width: 40px;
            height: 40px;
            background: #fef2f2;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .history-item-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--red);
            fill: none;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .history-item-info {
            flex: 1;
            min-width: 0;
        }
        .history-item-info h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item-meta {
            font-size: 12px;
            color: #9ca3af;
        }
        .history-item-stats {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .history-stat {
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        .history-stat-high { background: #fef2f2; color: var(--red); }
        .history-stat-medium { background: #fffbeb; color: #d97706; }
        .history-stat-count { background: #f3f4f6; color: var(--dark); }
        .history-empty {
            text-align: center;
            padding: 64px 32px;
            color: var(--gray);
        }
        .history-empty h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        .history-empty p {
            font-size: 14px;
            max-width: none;
            animation: none;
            margin: 0;
        }

        @media (max-width: 640px) {
            .mapper-header { padding: 16px 20px; }
            .mapper-content { padding: 32px 16px; }
            .upload-zone { padding: 40px 20px; }
            .history-item { flex-wrap: wrap; }
            .history-item-stats { width: 100%; margin-top: 4px; }
        }
    </style>
</head>
<body>

<!-- Decorative ADAS equipment illustrations -->
<!-- Autel Diagnostic Tablet -->
<div class="deco deco-tablet">
    <svg viewBox="0 0 120 160" xmlns="http://www.w3.org/2000/svg">
        <!-- Tablet body -->
        <rect x="10" y="8" width="100" height="144" rx="10" ry="10"/>
        <!-- Screen -->
        <rect x="18" y="20" width="84" height="108" rx="4" ry="4"/>
        <!-- Home button -->
        <circle cx="60" cy="142" r="5"/>
        <!-- Screen content - diagnostic UI -->
        <line x1="28" y1="40" x2="92" y2="40"/>
        <line x1="28" y1="52" x2="72" y2="52"/>
        <line x1="28" y1="64" x2="82" y2="64"/>
        <!-- Car outline on screen -->
        <path d="M42 85 L48 75 L72 75 L78 85 L82 90 L82 100 L38 100 L38 90 Z"/>
        <!-- Wheels -->
        <circle cx="46" cy="100" r="4"/>
        <circle cx="74" cy="100" r="4"/>
        <!-- Status bar -->
        <rect x="28" y="108" width="20" height="6" rx="2"/>
        <rect x="52" y="108" width="30" height="6" rx="2"/>
    </svg>
</div>

<!-- Windshield Camera Calibration Target -->
<div class="deco deco-target">
    <svg viewBox="0 0 140 160" xmlns="http://www.w3.org/2000/svg">
        <!-- Target board frame -->
        <rect x="10" y="10" width="120" height="90" rx="3" ry="3"/>
        <!-- Inner border -->
        <rect x="18" y="18" width="104" height="74" rx="2" ry="2"/>
        <!-- Crosshair pattern -->
        <line x1="70" y1="18" x2="70" y2="92"/>
        <line x1="18" y1="55" x2="122" y2="55"/>
        <!-- Target circles -->
        <circle cx="70" cy="55" r="16"/>
        <circle cx="70" cy="55" r="8"/>
        <circle cx="70" cy="55" r="3"/>
        <!-- Corner markers -->
        <rect x="22" y="22" width="12" height="12"/>
        <rect x="106" y="22" width="12" height="12"/>
        <rect x="22" y="74" width="12" height="12"/>
        <rect x="106" y="74" width="12" height="12"/>
        <!-- Stand legs -->
        <line x1="50" y1="100" x2="30" y2="155"/>
        <line x1="90" y1="100" x2="110" y2="155"/>
        <line x1="70" y1="100" x2="70" y2="150"/>
        <!-- Crossbar -->
        <line x1="42" y1="125" x2="98" y2="125"/>
    </svg>
</div>

<!-- Radar Reflector Target -->
<div class="deco deco-radar">
    <svg viewBox="0 0 120 130" xmlns="http://www.w3.org/2000/svg">
        <!-- Reflector body - corner reflector shape -->
        <path d="M20 30 L60 10 L100 30 L100 80 L60 100 L20 80 Z"/>
        <!-- Inner facets -->
        <line x1="60" y1="10" x2="60" y2="100"/>
        <line x1="20" y1="55" x2="100" y2="55"/>
        <!-- Radar wave arcs -->
        <path d="M60 40 Q45 55 60 70" fill="none"/>
        <path d="M60 40 Q75 55 60 70" fill="none"/>
        <path d="M55 35 Q35 55 55 75" fill="none"/>
        <path d="M65 35 Q85 55 65 75" fill="none"/>
        <!-- Mounting pole -->
        <line x1="60" y1="100" x2="60" y2="125"/>
        <!-- Base -->
        <ellipse cx="60" cy="125" rx="20" ry="5"/>
    </svg>
</div>

<!-- Target Stand with Wheel Alignment -->
<div class="deco deco-stand">
    <svg viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
        <!-- Vertical pole -->
        <line x1="50" y1="10" x2="50" y2="110"/>
        <!-- Horizontal arm -->
        <line x1="20" y1="25" x2="80" y2="25"/>
        <!-- Mounting bracket -->
        <rect x="40" y="15" width="20" height="20" rx="2"/>
        <!-- Height adjustment marks -->
        <line x1="46" y1="45" x2="54" y2="45"/>
        <line x1="46" y1="55" x2="54" y2="55"/>
        <line x1="46" y1="65" x2="54" y2="65"/>
        <line x1="46" y1="75" x2="54" y2="75"/>
        <!-- Clamp knob -->
        <circle cx="58" cy="85" r="4"/>
        <!-- Tripod base -->
        <line x1="50" y1="110" x2="15" y2="135"/>
        <line x1="50" y1="110" x2="85" y2="135"/>
        <line x1="50" y1="110" x2="50" y2="138"/>
        <!-- Feet -->
        <circle cx="15" cy="135" r="3"/>
        <circle cx="85" cy="135" r="3"/>
        <circle cx="50" cy="138" r="3"/>
    </svg>
</div>

<div class="container">
    <a href="https://adastrak.com">
        <img src="logo-full.png" alt="TRAK" class="logo">
    </a>

    <h1>Built by calibrators, <span>for calibrators.</span></h1>

    <p>TRAK is the operating system for ADAS calibration businesses and collision centers performing calibrations. It unifies scheduling, required calibration reporting, workflow and documentation, billing, analytics, and customer access into a single platform built specifically for the calibration industry.</p>

    <div class="ctas">
        <a href="https://calendly.com/will-adastrak/30min" class="btn btn-primary">Book a Demo</a>
        <a href="tel:+18474719455" class="btn btn-outline">Call (847) 471-9455</a>
    </div>

    <div class="features">
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
            <h3>Scheduling</h3>
            <p>Manage appointments, technician availability, and bay schedules from one calendar.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
            <h3>Calibration Reports</h3>
            <p>Auto-generate required calibration documentation ready for insurers and shops.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
            <h3>Workflow</h3>
            <p>Track every job from intake to completion with real-time status updates.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
            <h3>Billing</h3>
            <p>Invoice customers, track payments, and manage pricing by calibration type.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg></div>
            <h3>Analytics</h3>
            <p>Revenue, turnaround times, technician performance, and shop-level insights.</p>
        </div>
        <div class="feature-card" id="customer-portal-trigger" style="cursor:pointer">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
            <h3>Customer Portal</h3>
            <p>Give shops and insurers real-time visibility into job status and reports.</p>
        </div>
    </div>

    <div class="divider"></div>
    <p class="footer-contact">New York, NY &middot; <a href="mailto:team@get-trak.com">team@get-trak.com</a></p>
    <p class="footer-text">&copy; 2026 TRAK &middot; <a href="https://adastrak.com">adastrak.com</a></p>
    <p class="footer-links"><a href="https://adastrak.com">Privacy Policy</a> &middot; <a href="https://adastrak.com">Terms of Service</a></p>
</div>

<!-- Password Modal -->
<div class="password-overlay" id="password-overlay">
    <div class="password-modal">
        <h2>Enter Access Code</h2>
        <p class="modal-subtitle">This area is restricted.</p>
        <input type="password" id="password-input" placeholder="Access code" autocomplete="off">
        <p class="password-error" id="password-error">Incorrect access code</p>
        <button class="modal-btn" id="password-submit">Submit</button>
        <button class="modal-cancel" id="password-cancel">Cancel</button>
    </div>
</div>

<!-- Mapper Section -->
<div class="mapper-section" id="mapper-section">
    <div class="mapper-header">
        <div class="mapper-header-left">
            <img src="logo-full.png" alt="TRAK">
            <h1>Mapper</h1>
        </div>
        <div class="mapper-header-right">
            <button class="mapper-history-btn" id="mapper-history-btn">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                History
                <span class="history-badge" id="history-badge" style="display:none">0</span>
            </button>
            <button class="mapper-back" id="mapper-back">Back to Home</button>
        </div>
    </div>
    <div class="mapper-content">
        <div id="upload-section">
            <div class="upload-zone" id="upload-zone">
                <div class="upload-zone-icon">
                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <h3>Upload Collision Repair Estimate</h3>
                <p>Drag & drop a PDF estimate, or click to browse</p>
                <span class="browse-btn">Browse Files</span>
                <input type="file" id="pdf-file-input" accept=".pdf" style="display:none">
            </div>
        </div>
        <div class="processing-state" id="processing-state">
            <div class="processing-spinner"></div>
            <p>Analyzing estimate for ADAS calibration requirements...</p>
        </div>
        <div class="results-section" id="results-section"></div>
        <div class="history-section" id="history-section"></div>
    </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const CALIBRATION_MAP = [
    {
        id: 'forward-camera',
        name: 'Forward Camera Calibration',
        calibrationType: 'Static & Dynamic',
        priority: 'high',
        description: 'The forward-facing camera must be recalibrated to ensure proper operation of lane departure warning, automatic emergency braking, and adaptive cruise control.',
        triggers: [
            ['windshield', 'w/shield', 'wshield', 'w/s glass'],
            ['forward camera', 'front camera', 'adas camera', 'camera bracket', 'camera assy'],
            ['rearview mirror', 'rear view mirror', 'interior mirror', 'inside mirror', 'mirror assy inside']
        ]
    },
    {
        id: 'front-radar',
        name: 'Front Radar Sensor Calibration',
        calibrationType: 'Static',
        priority: 'high',
        description: 'The front radar sensor must be recalibrated for adaptive cruise control and automatic emergency braking to function properly.',
        triggers: [
            ['front bumper', 'frt bumper', 'bumper cover frt', 'bumper assy frt', 'front fascia', 'frt fascia', 'bumper fascia frt'],
            ['grille', 'grill', 'radiator grille', 'upper grille', 'lower grille'],
            ['front radar', 'radar sensor', 'radar bracket', 'radar module', 'distance sensor'],
            ['radiator support', 'rad support', 'radiator core support', 'core support'],
            ['condenser', 'a/c condenser'],
            ['front emblem', 'front badge']
        ]
    },
    {
        id: 'blind-spot',
        name: 'Blind Spot Monitor Calibration',
        calibrationType: 'Dynamic',
        priority: 'high',
        description: 'Blind spot monitoring sensors must be recalibrated to accurately detect vehicles in adjacent lanes.',
        triggers: [
            ['rear bumper', 'rr bumper', 'bumper cover rr', 'bumper assy rr', 'rear fascia', 'rr fascia', 'bumper fascia rr'],
            ['quarter panel', 'qtr panel', 'quarter pnl', 'qtr pnl'],
            ['blind spot', 'bsm', 'blind spot sensor', 'blind spot monitor', 'blind spot radar'],
            ['rear body panel', 'body panel rr'],
            ['liftgate', 'tailgate', 'trunk lid', 'back door']
        ]
    },
    {
        id: 'rear-parking',
        name: 'Parking Sensor Calibration',
        calibrationType: 'Static',
        priority: 'medium',
        description: 'Parking sensors and/or rear cross-traffic alert sensors must be recalibrated after bumper or sensor removal.',
        triggers: [
            ['parking sensor', 'park sensor', 'ultrasonic sensor', 'park assist', 'sonar sensor'],
            ['rear cross traffic', 'rcta', 'cross traffic alert']
        ]
    },
    {
        id: 'rear-camera',
        name: 'Rear / Surround View Camera Calibration',
        calibrationType: 'Static',
        priority: 'medium',
        description: 'Rear or surround view cameras must be recalibrated to ensure accurate guidelines and object detection.',
        triggers: [
            ['rear camera', 'backup camera', 'back up camera', 'reverse camera', 'rearview camera'],
            ['surround view', 'surround camera', '360 camera', 'around view']
        ]
    },
    {
        id: 'headlight-aiming',
        name: 'Headlight Aiming',
        calibrationType: 'Static',
        priority: 'medium',
        description: 'Headlights must be aimed after replacement or structural repair that may affect headlight positioning.',
        triggers: [
            ['headlamp', 'headlight', 'head lamp', 'head light'],
            ['headlamp bracket', 'headlight bracket', 'headlamp mount'],
            ['headlamp assy', 'headlight assy', 'headlamp assembly', 'headlight assembly']
        ]
    },
    {
        id: 'steering-angle',
        name: 'Steering Angle Sensor Calibration',
        calibrationType: 'Reset / Initialize',
        priority: 'high',
        description: 'The steering angle sensor must be recalibrated to ensure proper function of electronic stability control and ADAS features.',
        triggers: [
            ['wheel alignment', 'four wheel alignment', '4 wheel alignment', 'thrust angle alignment', 'alignment check'],
            ['steering column', 'steering gear', 'steering rack', 'rack and pinion', 'rack & pinion', 'power steering'],
            ['steering angle sensor', 'clock spring', 'clockspring', 'spiral cable'],
            ['tie rod', 'tierod', 'tie-rod', 'inner tie rod', 'outer tie rod'],
            ['subframe', 'sub frame', 'front subframe', 'engine cradle', 'front crossmember']
        ]
    },
    {
        id: 'side-mirror-sensor',
        name: 'Side Mirror / Lane Change Assist Calibration',
        calibrationType: 'Dynamic',
        priority: 'medium',
        description: 'Side mirror-integrated sensors may require recalibration for blind spot and lane change assist systems.',
        triggers: [
            ['side mirror', 'door mirror', 'outside mirror', 'o/s mirror', 'mirror assy door', 'mirror assembly door', 'power mirror']
        ]
    },
    {
        id: 'occupant-classification',
        name: 'Occupant Classification System Calibration',
        calibrationType: 'Static',
        priority: 'medium',
        description: 'The occupant classification system must be recalibrated after seat or airbag sensor removal to ensure proper airbag deployment.',
        triggers: [
            ['occupant sensor', 'occupant classification', 'weight sensor', 'seat sensor', 'seat pressure'],
            ['front seat', 'seat cushion', 'seat frame', 'seat track', 'seat assy'],
            ['airbag', 'air bag', 'srs module', 'supplemental restraint']
        ]
    },
    {
        id: 'ride-height',
        name: 'Ride Height / Suspension Calibration',
        calibrationType: 'Static',
        priority: 'medium',
        description: 'Ride height sensors and adaptive suspension must be recalibrated after suspension component replacement.',
        triggers: [
            ['ride height', 'height sensor', 'level sensor'],
            ['strut', 'strut assy', 'shock absorber', 'coil spring', 'air spring', 'air suspension'],
            ['control arm', 'lower arm', 'upper arm', 'trailing arm']
        ]
    }
];

const VEHICLE_MAKES = ['Toyota','Honda','Ford','Chevrolet','Chevy','Nissan','Hyundai','Kia','Subaru','Mazda','BMW','Mercedes','Audi','Volkswagen','VW','Lexus','Acura','Infiniti','Volvo','Jeep','Dodge','Ram','Chrysler','GMC','Buick','Cadillac','Lincoln','Tesla','Porsche','Land Rover','Range Rover','Jaguar','Genesis','Rivian','Lucid','Mitsubishi','Mini','Fiat','Alfa Romeo','Maserati','Bentley','Rolls Royce','Polestar','Scion','Saturn','Pontiac'];

// DOM refs
const passwordOverlay = document.getElementById('password-overlay');
const passwordInput = document.getElementById('password-input');
const passwordError = document.getElementById('password-error');
const mapperSection = document.getElementById('mapper-section');
const uploadZone = document.getElementById('upload-zone');
const pdfFileInput = document.getElementById('pdf-file-input');
const processingState = document.getElementById('processing-state');
const resultsSection = document.getElementById('results-section');
const uploadSection = document.getElementById('upload-section');
const historySection = document.getElementById('history-section');
const historyBadge = document.getElementById('history-badge');

// Open password modal from Customer Portal card
document.getElementById('customer-portal-trigger').addEventListener('click', function() {
    passwordOverlay.style.display = 'flex';
    requestAnimationFrame(function() {
        passwordOverlay.classList.add('active');
        passwordInput.focus();
    });
});

// Password submit
document.getElementById('password-submit').addEventListener('click', checkPassword);
passwordInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') checkPassword();
});

function checkPassword() {
    if (passwordInput.value === 'trak1') {
        closePasswordModal();
        openMapper();
    } else {
        passwordInput.classList.add('shake');
        passwordError.style.display = 'block';
        setTimeout(function() { passwordInput.classList.remove('shake'); }, 400);
    }
}

// Close modal
document.getElementById('password-cancel').addEventListener('click', closePasswordModal);
passwordOverlay.addEventListener('click', function(e) {
    if (e.target === passwordOverlay) closePasswordModal();
});

function closePasswordModal() {
    passwordOverlay.classList.remove('active');
    setTimeout(function() {
        passwordOverlay.style.display = 'none';
        passwordInput.value = '';
        passwordError.style.display = 'none';
    }, 300);
}

// Mapper open/close
function openMapper() {
    mapperSection.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

document.getElementById('mapper-back').addEventListener('click', closeMapper);

function closeMapper() {
    mapperSection.style.display = 'none';
    document.body.style.overflow = '';
    resetMapper();
}

function resetMapper() {
    uploadSection.style.display = 'block';
    processingState.style.display = 'none';
    resultsSection.style.display = 'none';
    historySection.style.display = 'none';
    resultsSection.innerHTML = '';
    pdfFileInput.value = '';
    // Reset processing state in case of prior error
    processingState.innerHTML = '<div class="processing-spinner"></div><p>Analyzing estimate for ADAS calibration requirements...</p>';
}

// File upload
uploadZone.addEventListener('click', function() { pdfFileInput.click(); });

uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});
uploadZone.addEventListener('dragleave', function() {
    uploadZone.classList.remove('dragover');
});
uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    var file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') processFile(file);
});
pdfFileInput.addEventListener('change', function() {
    if (this.files[0]) processFile(this.files[0]);
});

// PDF Processing
async function processFile(file) {
    uploadSection.style.display = 'none';
    processingState.style.display = 'block';

    try {
        var arrayBuffer = await file.arrayBuffer();
        var pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        var fullText = '';

        for (var i = 1; i <= pdf.numPages; i++) {
            var page = await pdf.getPage(i);
            var textContent = await page.getTextContent();
            var pageText = textContent.items.map(function(item) { return item.str; }).join(' ');
            fullText += pageText + '\n';
        }

        var results = analyzeEstimate(fullText);
        displayResults(results, file.name);
    } catch (err) {
        processingState.innerHTML =
            '<div style="text-align:center;padding:48px">' +
            '<p style="color:var(--red);font-weight:600;margin-bottom:12px;max-width:none;animation:none">Error processing PDF</p>' +
            '<p style="color:var(--gray);font-size:14px;max-width:none;animation:none">' + (err.message || 'Could not read the PDF file.') + '</p>' +
            '<button onclick="resetMapper()" style="margin-top:20px;padding:10px 24px;background:var(--red);color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit">Try Again</button>' +
            '</div>';
    }
}

// Analysis engine
function analyzeEstimate(text) {
    var lowerText = text.toLowerCase();
    var lines = text.split(/\n/).filter(function(l) { return l.trim(); });
    var foundCalibrations = [];
    var vehicleInfo = extractVehicleInfo(text);

    for (var m = 0; m < CALIBRATION_MAP.length; m++) {
        var mapping = CALIBRATION_MAP[m];
        var matchedTriggers = [];

        for (var t = 0; t < mapping.triggers.length; t++) {
            var keywordGroup = mapping.triggers[t];
            for (var k = 0; k < keywordGroup.length; k++) {
                var keyword = keywordGroup[k];
                if (lowerText.indexOf(keyword.toLowerCase()) !== -1) {
                    var matchLine = findMatchingLine(lines, keyword);
                    if (matchedTriggers.indexOf(matchLine) === -1) {
                        matchedTriggers.push(matchLine);
                    }
                }
            }
        }

        if (matchedTriggers.length > 0) {
            foundCalibrations.push({
                id: mapping.id,
                name: mapping.name,
                calibrationType: mapping.calibrationType,
                priority: mapping.priority,
                description: mapping.description,
                matchedTriggers: matchedTriggers
            });
        }
    }

    return { calibrations: foundCalibrations, vehicleInfo: vehicleInfo };
}

function extractVehicleInfo(text) {
    var yearMatch = text.match(/\b(19[9]\d|20[0-2]\d)\b/);
    var vinMatch = text.match(/\b[A-HJ-NPR-Z0-9]{17}\b/);
    var foundMake = '';
    var lowerText = text.toLowerCase();
    for (var i = 0; i < VEHICLE_MAKES.length; i++) {
        if (lowerText.indexOf(VEHICLE_MAKES[i].toLowerCase()) !== -1) {
            foundMake = VEHICLE_MAKES[i];
            break;
        }
    }
    return {
        year: yearMatch ? yearMatch[0] : '',
        make: foundMake,
        vin: vinMatch ? vinMatch[0] : ''
    };
}

function findMatchingLine(lines, keyword) {
    var lower = keyword.toLowerCase();
    for (var i = 0; i < lines.length; i++) {
        if (lines[i].toLowerCase().indexOf(lower) !== -1) {
            return lines[i].trim().substring(0, 120);
        }
    }
    return keyword;
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function displayResults(results, fileName) {
    processingState.style.display = 'none';
    resultsSection.style.display = 'block';

    var cals = results.calibrations;
    var v = results.vehicleInfo;
    var vehicleStr = [v.year, v.make].filter(Boolean).join(' ');

    var html = '<div class="results-header">';
    html += '<h2>Required ADAS Calibrations</h2>';
    if (vehicleStr) {
        html += '<p class="results-vehicle">' + escapeHtml(vehicleStr) + (v.vin ? ' &middot; VIN: ' + escapeHtml(v.vin) : '') + '</p>';
    }
    html += '<p class="results-file">' + escapeHtml(fileName) + '</p>';

    if (cals.length > 0) {
        html += '<span class="results-summary">' + cals.length + ' calibration' + (cals.length !== 1 ? 's' : '') + ' identified</span>';
        html += '</div>';
        html += '<div class="results-grid">';

        var priorityOrder = { high: 0, medium: 1, low: 2 };
        cals.sort(function(a, b) { return (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2); });

        for (var i = 0; i < cals.length; i++) {
            var cal = cals[i];
            html += '<div class="calibration-card">';
            html += '<div class="cal-priority cal-priority-' + cal.priority + '"></div>';
            html += '<div class="cal-info">';
            html += '<div class="cal-type">' + escapeHtml(cal.calibrationType) + '</div>';
            html += '<h3>' + escapeHtml(cal.name) + '</h3>';
            html += '<p>' + escapeHtml(cal.description) + '</p>';
            html += '<div class="cal-triggers">';
            for (var j = 0; j < cal.matchedTriggers.length; j++) {
                html += '<span>' + escapeHtml(cal.matchedTriggers[j]) + '</span>';
            }
            html += '</div></div></div>';
        }
        html += '</div>';
    } else {
        html += '</div>';
        html += '<div class="no-calibrations">';
        html += '<h3>No ADAS calibrations identified</h3>';
        html += '<p>No common ADAS calibration triggers were found in this estimate. This does not necessarily mean no calibrations are required &mdash; always verify with OEM procedures.</p>';
        html += '</div>';
    }

    html += '<div class="results-actions">';
    if (cals.length > 0) {
        html += '<button class="btn-download-pdf" onclick="downloadCurrentPDF()"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Download PDF Report</button>';
    }
    html += '<button onclick="resetMapper()">Upload Another Estimate</button>';
    html += '</div>';

    // Store current results for PDF download
    window._currentReport = { calibrations: cals, vehicleInfo: v, fileName: fileName };

    resultsSection.innerHTML = html;

    // Save to history (skip if we're viewing a past report)
    if (!results._fromHistory) {
        saveToHistory(results, fileName);
    }
}

// --- History ---
var HISTORY_KEY = 'trak_mapper_history';

function getHistory() {
    try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    } catch (e) { return []; }
}

function saveToHistory(results, fileName) {
    var history = getHistory();
    var entry = {
        id: Date.now(),
        date: new Date().toISOString(),
        fileName: fileName,
        vehicleInfo: results.vehicleInfo,
        calibrations: results.calibrations
    };
    history.unshift(entry);
    // Keep last 50 reports
    if (history.length > 50) history = history.slice(0, 50);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    updateHistoryBadge();
}

function updateHistoryBadge() {
    var count = getHistory().length;
    if (count > 0) {
        historyBadge.textContent = count;
        historyBadge.style.display = 'inline-flex';
    } else {
        historyBadge.style.display = 'none';
    }
}

function showHistory() {
    uploadSection.style.display = 'none';
    processingState.style.display = 'none';
    resultsSection.style.display = 'none';
    historySection.style.display = 'block';

    var history = getHistory();
    var html = '<div class="history-header">';
    html += '<h2>Report History</h2>';
    if (history.length > 0) {
        html += '<button class="history-clear-btn" onclick="clearHistory()">Clear All</button>';
    }
    html += '</div>';

    if (history.length === 0) {
        html += '<div class="history-empty">';
        html += '<h3>No reports yet</h3>';
        html += '<p>Upload a collision repair estimate and your results will appear here.</p>';
        html += '</div>';
    } else {
        html += '<div class="history-list">';
        for (var i = 0; i < history.length; i++) {
            var entry = history[i];
            var v = entry.vehicleInfo || {};
            var vehicleStr = [v.year, v.make].filter(Boolean).join(' ') || 'Unknown Vehicle';
            var d = new Date(entry.date);
            var dateStr = (d.getMonth() + 1) + '/' + d.getDate() + '/' + d.getFullYear() + ' ' + d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            var cals = entry.calibrations || [];
            var highCount = 0;
            var medCount = 0;
            for (var j = 0; j < cals.length; j++) {
                if (cals[j].priority === 'high') highCount++;
                else medCount++;
            }

            html += '<div class="history-item" onclick="viewHistoryItem(' + entry.id + ')">';
            html += '<div class="history-item-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>';
            html += '<div class="history-item-info">';
            html += '<h4>' + escapeHtml(vehicleStr) + '</h4>';
            html += '<span class="history-item-meta">' + escapeHtml(entry.fileName) + ' &middot; ' + dateStr + '</span>';
            html += '</div>';
            html += '<div class="history-item-stats">';
            if (cals.length === 0) {
                html += '<span class="history-stat history-stat-count">0 calibrations</span>';
            } else {
                if (highCount > 0) html += '<span class="history-stat history-stat-high">' + highCount + ' high</span>';
                if (medCount > 0) html += '<span class="history-stat history-stat-medium">' + medCount + ' med</span>';
            }
            html += '</div>';
            if (cals.length > 0) {
                html += '<button class="history-item-download" onclick="event.stopPropagation();downloadHistoryPDF(' + entry.id + ')" title="Download PDF"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>';
            }
            html += '</div>';
        }
        html += '</div>';
    }

    html += '<div style="text-align:center;padding-top:24px"><button class="btn-download-pdf" onclick="resetMapper()" style="font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;padding:12px 28px;border-radius:10px;border:none;display:inline-flex;align-items:center;gap:8px"><svg viewBox="0 0 24 24" style="width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload New Estimate</button></div>';

    historySection.innerHTML = html;
}

function viewHistoryItem(id) {
    var history = getHistory();
    var entry = null;
    for (var i = 0; i < history.length; i++) {
        if (history[i].id === id) { entry = history[i]; break; }
    }
    if (!entry) return;

    historySection.style.display = 'none';
    var results = {
        calibrations: entry.calibrations,
        vehicleInfo: entry.vehicleInfo,
        _fromHistory: true
    };
    displayResults(results, entry.fileName);
}

function clearHistory() {
    localStorage.removeItem(HISTORY_KEY);
    updateHistoryBadge();
    showHistory();
}

document.getElementById('mapper-history-btn').addEventListener('click', showHistory);

// --- PDF Report Generation ---
function generateReportPDF(reportData) {
    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF({ unit: 'mm', format: 'letter' });
    var W = doc.internal.pageSize.getWidth();
    var H = doc.internal.pageSize.getHeight();
    var margin = 20;
    var usable = W - margin * 2;
    var y = 0;

    var RED = [220, 38, 38];
    var DARK = [26, 26, 26];
    var GRAY = [107, 114, 128];
    var LIGHT_GRAY = [156, 163, 175];
    var AMBER = [245, 158, 11];
    var GREEN = [16, 185, 129];
    var BG_RED = [254, 242, 242];
    var BG_LIGHT = [249, 250, 251];

    var cals = reportData.calibrations || [];
    var v = reportData.vehicleInfo || {};
    var vehicleStr = [v.year, v.make].filter(Boolean).join(' ');
    var fileName = reportData.fileName || 'estimate.pdf';
    var reportDate = reportData.date ? new Date(reportData.date) : new Date();
    var dateStr = reportDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    var timeStr = reportDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

    function addFooter() {
        doc.setDrawColor(230, 230, 230);
        doc.line(margin, H - 16, W - margin, H - 16);
        doc.setFontSize(8);
        doc.setTextColor.apply(doc, LIGHT_GRAY);
        doc.text('Generated by TRAK Mapper  |  get-trak.com', margin, H - 10);
        doc.text(dateStr + ' at ' + timeStr, W - margin, H - 10, { align: 'right' });
    }

    function checkPage(needed) {
        if (y + needed > H - 24) {
            addFooter();
            doc.addPage();
            y = 20;
        }
    }

    // === Header band ===
    doc.setFillColor.apply(doc, RED);
    doc.rect(0, 0, W, 3, 'F');

    // === TRAK wordmark ===
    y = 22;
    doc.setFontSize(26);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor.apply(doc, RED);
    doc.text('TRAK', margin, y);
    doc.setFontSize(11);
    doc.setTextColor.apply(doc, GRAY);
    doc.text('Mapper', margin + doc.getTextWidth('TRAK ') + 2, y);

    // Report title right-aligned
    doc.setFontSize(10);
    doc.setTextColor.apply(doc, LIGHT_GRAY);
    doc.text('ADAS Calibration Report', W - margin, y, { align: 'right' });

    // Divider
    y += 6;
    doc.setDrawColor(240, 240, 240);
    doc.line(margin, y, W - margin, y);

    // === Vehicle info block ===
    y += 12;
    if (vehicleStr) {
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor.apply(doc, DARK);
        doc.text(vehicleStr, margin, y);
        y += 7;
    }
    if (v.vin) {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor.apply(doc, GRAY);
        doc.text('VIN: ' + v.vin, margin, y);
        y += 5;
    }
    doc.setFontSize(9);
    doc.setTextColor.apply(doc, LIGHT_GRAY);
    doc.text('Source: ' + fileName, margin, y);
    y += 4;
    doc.text('Date: ' + dateStr, margin, y);

    // === Summary badge ===
    y += 12;
    var summaryText = cals.length + ' calibration' + (cals.length !== 1 ? 's' : '') + ' identified';
    var highCount = 0, medCount = 0;
    for (var c = 0; c < cals.length; c++) {
        if (cals[c].priority === 'high') highCount++;
        else medCount++;
    }

    // Summary pill
    doc.setFillColor.apply(doc, BG_RED);
    var pillW = doc.getTextWidth(summaryText) * 1.1 + 14;
    doc.roundedRect(margin, y - 5, pillW, 9, 3, 3, 'F');
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor.apply(doc, RED);
    doc.text(summaryText, margin + 7, y + 1);

    // Priority breakdown next to pill
    var bx = margin + pillW + 8;
    if (highCount > 0) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor.apply(doc, RED);
        doc.text(highCount + ' High Priority', bx, y + 1);
        bx += doc.getTextWidth(highCount + ' High Priority') + 6;
    }
    if (medCount > 0) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor.apply(doc, AMBER);
        doc.text(medCount + ' Medium Priority', bx, y + 1);
    }

    y += 14;

    // === Calibration cards ===
    var priorityOrder = { high: 0, medium: 1, low: 2 };
    cals.sort(function(a, b) { return (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2); });

    for (var i = 0; i < cals.length; i++) {
        var cal = cals[i];

        // Estimate card height
        var descLines = doc.setFontSize(9).setFont('helvetica', 'normal').splitTextToSize(cal.description, usable - 14);
        var triggerLines = [];
        for (var t = 0; t < cal.matchedTriggers.length; t++) {
            triggerLines.push(cal.matchedTriggers[t]);
        }
        var triggerText = 'Matched: ' + triggerLines.join('  |  ');
        var triggerWrapped = doc.splitTextToSize(triggerText, usable - 14);
        var cardH = 10 + 7 + (descLines.length * 4) + 6 + (triggerWrapped.length * 3.5) + 8;

        checkPage(cardH + 4);

        // Card background
        doc.setFillColor.apply(doc, BG_LIGHT);
        doc.roundedRect(margin, y, usable, cardH, 3, 3, 'F');

        // Priority bar
        var barColor = cal.priority === 'high' ? RED : (cal.priority === 'medium' ? AMBER : GREEN);
        doc.setFillColor.apply(doc, barColor);
        doc.roundedRect(margin, y, 3, cardH, 1.5, 1.5, 'F');

        var cx = margin + 8;
        var cy = y + 7;

        // Calibration type label
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor.apply(doc, barColor);
        doc.text(cal.calibrationType.toUpperCase() + '  |  ' + cal.priority.toUpperCase() + ' PRIORITY', cx, cy);
        cy += 6;

        // Name
        doc.setFontSize(13);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor.apply(doc, DARK);
        doc.text(cal.name, cx, cy);
        cy += 7;

        // Description
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor.apply(doc, GRAY);
        doc.text(descLines, cx, cy);
        cy += descLines.length * 4 + 4;

        // Triggers
        doc.setDrawColor(230, 230, 230);
        doc.line(cx, cy - 2, margin + usable - 8, cy - 2);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor.apply(doc, LIGHT_GRAY);
        doc.text(triggerWrapped, cx, cy + 2);

        y += cardH + 5;
    }

    // === Disclaimer ===
    checkPage(20);
    y += 4;
    doc.setDrawColor(240, 240, 240);
    doc.line(margin, y, W - margin, y);
    y += 7;
    doc.setFontSize(8);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor.apply(doc, LIGHT_GRAY);
    var disclaimer = 'This report is generated based on keyword analysis of the uploaded estimate and may not capture all required calibrations. Always verify with OEM repair procedures and position statements.';
    var discLines = doc.splitTextToSize(disclaimer, usable);
    doc.text(discLines, margin, y);

    addFooter();

    // File name for download
    var safeName = (vehicleStr || 'Vehicle').replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_');
    doc.save('TRAK_Calibration_Report_' + safeName + '.pdf');
}

function downloadCurrentPDF() {
    if (window._currentReport) {
        generateReportPDF(window._currentReport);
    }
}

function downloadHistoryPDF(id) {
    var history = getHistory();
    for (var i = 0; i < history.length; i++) {
        if (history[i].id === id) {
            generateReportPDF({
                calibrations: history[i].calibrations,
                vehicleInfo: history[i].vehicleInfo,
                fileName: history[i].fileName,
                date: history[i].date
            });
            return;
        }
    }
}

// Update badge on load
updateHistoryBadge();
</script>

</body>
</html>
